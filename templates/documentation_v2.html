{% extends "base.html" %}

{% block title %}Validation Documentation - NCIRD{% endblock %}

{% block extra_css %}
<style>
    .doc-intro {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 8px;
        margin-bottom: 2rem;
    }

    .doc-intro h1 {
        color: white;
        margin-bottom: 1rem;
    }

    .quality-dimensions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 1rem;
        margin: 2rem 0;
    }

    .dimension-card {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-top: 4px solid #2c5282;
        cursor: pointer;
        transition: transform 0.2s;
    }

    .dimension-card:hover {
        transform: translateY(-4px);
    }

    .dimension-icon {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
    }

    .dimension-name {
        font-weight: 600;
        color: #1e3a5f;
        margin-bottom: 0.25rem;
    }

    .dimension-desc {
        font-size: 0.85rem;
        color: #666;
    }

    /* Accordion styles */
    .accordion {
        background: white;
        border-radius: 8px;
        margin-bottom: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .accordion-header {
        background: #f8f9fa;
        padding: 1.5rem;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-left: 4px solid #2c5282;
        transition: background 0.3s;
    }

    .accordion-header:hover {
        background: #e9ecef;
    }

    .accordion-header.active {
        background: #2c5282;
        color: white;
    }

    .accordion-title {
        font-size: 1.25rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .accordion-icon {
        font-size: 1.5rem;
    }

    .accordion-toggle {
        font-size: 1.5rem;
        transition: transform 0.3s;
    }

    .accordion-toggle.active {
        transform: rotate(180deg);
    }

    .accordion-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
    }

    .accordion-content.show {
        max-height: 5000px;
        transition: max-height 0.5s ease-in;
    }

    .accordion-body {
        padding: 2rem;
    }

    /* System selector tabs */
    .system-tabs {
        display: flex;
        gap: 1rem;
        margin: 2rem 0;
        flex-wrap: wrap;
    }

    .system-tab {
        padding: 0.75rem 1.5rem;
        background: #e9ecef;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
    }

    .system-tab:hover {
        background: #dee2e6;
    }

    .system-tab.active {
        background: #2c5282;
        color: white;
    }

    .system-content {
        display: none;
    }

    .system-content.active {
        display: block;
    }

    /* Validation rule cards */
    .rule-grid {
        display: grid;
        gap: 1rem;
        margin: 1rem 0;
    }

    .rule-card {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 6px;
        border-left: 4px solid #28a745;
    }

    .rule-card.warning {
        border-left-color: #ffc107;
    }

    .rule-card.error {
        border-left-color: #dc3545;
    }

    .rule-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .rule-title {
        font-weight: 600;
        color: #1e3a5f;
        font-size: 1.05rem;
    }

    .severity-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .severity-error { background: #dc3545; color: white; }
    .severity-warning { background: #ffc107; color: #333; }
    .severity-info { background: #17a2b8; color: white; }

    .rule-description {
        color: #333;
        line-height: 1.6;
        margin-bottom: 1rem;
    }

    .rule-examples {
        background: white;
        padding: 1rem;
        border-radius: 4px;
        margin-top: 1rem;
    }

    .example-label {
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #666;
    }

    .example-good {
        color: #28a745;
        font-family: 'Courier New', monospace;
        padding: 0.5rem;
        background: #d4edda;
        border-radius: 4px;
        margin: 0.5rem 0;
        font-size: 0.9rem;
    }

    .example-bad {
        color: #dc3545;
        font-family: 'Courier New', monospace;
        padding: 0.5rem;
        background: #f8d7da;
        border-radius: 4px;
        margin: 0.5rem 0;
        font-size: 0.9rem;
    }

    .code-toggle {
        background: #2c5282;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        margin-top: 0.5rem;
        transition: background 0.3s;
    }

    .code-toggle:hover {
        background: #1e3a5f;
    }

    .code-block {
        display: none;
        background: #282c34;
        color: #abb2bf;
        padding: 1rem;
        border-radius: 4px;
        margin-top: 1rem;
        overflow-x: auto;
        font-family: 'Courier New', monospace;
        font-size: 0.85rem;
        line-height: 1.5;
    }

    .code-block.show {
        display: block;
        animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .search-box {
        margin: 2rem 0;
        position: relative;
    }

    .search-input {
        width: 100%;
        padding: 1rem 1rem 1rem 3rem;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 1rem;
    }

    .search-input:focus {
        outline: none;
        border-color: #2c5282;
    }

    .search-icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #666;
        font-size: 1.2rem;
    }

    .framework-info {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 1rem 1.5rem;
        margin: 2rem 0;
        border-radius: 4px;
    }

    .framework-info strong {
        color: #856404;
    }
</style>
{% endblock %}

{% block content %}
<!-- Intro Section -->
<div class="doc-intro">
    <h1>üìö Validation Documentation</h1>
    <p style="font-size: 1.1rem; margin-bottom: 0;">
        Comprehensive data quality validation framework based on ISO 8000, CDC NNDSS guidelines,
        and WHO surveillance standards.
    </p>
</div>

<!-- Framework Info -->
<div class="framework-info">
    <strong>üéØ Data Quality Framework:</strong> All validations are organized according to the
    <strong>Six Data Quality Dimensions</strong> - industry-standard criteria for healthcare data quality
    established by ISO 8000, CDC, and WHO.
</div>

<!-- Data Quality Dimensions Overview -->
<h2 style="color: #1e3a5f; margin-bottom: 1rem;">Six Data Quality Dimensions</h2>
<div class="quality-dimensions">
    <div class="dimension-card" onclick="scrollToDimension('completeness')">
        <div class="dimension-icon">‚úì</div>
        <div class="dimension-name">Completeness</div>
        <div class="dimension-desc">All required data present</div>
    </div>
    <div class="dimension-card" onclick="scrollToDimension('accuracy')">
        <div class="dimension-icon">üéØ</div>
        <div class="dimension-name">Accuracy</div>
        <div class="dimension-desc">Values are correct</div>
    </div>
    <div class="dimension-card" onclick="scrollToDimension('consistency')">
        <div class="dimension-icon">üîó</div>
        <div class="dimension-name">Consistency</div>
        <div class="dimension-desc">No contradictions</div>
    </div>
    <div class="dimension-card" onclick="scrollToDimension('validity')">
        <div class="dimension-icon">‚úîÔ∏è</div>
        <div class="dimension-name">Validity</div>
        <div class="dimension-desc">Conforms to formats</div>
    </div>
    <div class="dimension-card" onclick="scrollToDimension('timeliness')">
        <div class="dimension-icon">‚è±Ô∏è</div>
        <div class="dimension-name">Timeliness</div>
        <div class="dimension-desc">Reported on time</div>
    </div>
    <div class="dimension-card" onclick="scrollToDimension('uniqueness')">
        <div class="dimension-icon">üîë</div>
        <div class="dimension-name">Uniqueness</div>
        <div class="dimension-desc">No duplicates</div>
    </div>
</div>

<!-- Search -->
<div class="search-box">
    <span class="search-icon">üîç</span>
    <input type="text" class="search-input" id="searchInput"
           placeholder="Search validations (e.g., 'date', 'jurisdiction', 'lab result')..."
           onkeyup="filterContent()">
</div>

<!-- System Selector -->
<h2 style="color: #1e3a5f; margin: 2rem 0 1rem 0;">Select Data Stream</h2>
<div class="system-tabs">
    <button class="system-tab active" onclick="showSystem('nnad')">NNAD</button>
    <button class="system-tab" onclick="showSystem('mumps')">Mumps</button>
    <button class="system-tab" onclick="showSystem('nrevss')">NREVSS</button>
</div>

<!-- NNAD System Content -->
<div id="nnad-content" class="system-content active">
    <h3 style="color: #1e3a5f; margin: 2rem 0 1rem;">NNAD (National Notifiable Diseases Surveillance System)</h3>

    <!-- Completeness -->
    <div class="accordion" id="completeness">
        <div class="accordion-header" onclick="toggleAccordion(this)">
            <div class="accordion-title">
                <span class="accordion-icon">‚úì</span>
                <span>1. COMPLETENESS - Required Data Elements</span>
            </div>
            <span class="accordion-toggle">‚ñº</span>
        </div>
        <div class="accordion-content">
            <div class="accordion-body">
                <p style="color: #666; margin-bottom: 1.5rem;">
                    Ensures all mandatory fields are present and populated. Missing data reduces surveillance effectiveness.
                </p>

                <div class="rule-grid">
                    <div class="rule-card error">
                        <div class="rule-header">
                            <span class="rule-title">1.1 Required Fields Must Exist</span>
                            <span class="severity-badge severity-error">ERROR</span>
                        </div>
                        <div class="rule-description">
                            File must contain all mandatory columns: condition, reporting_jurisdiction, case_status,
                            report_date, illness_onset_date. Missing columns prevent submission.
                        </div>
                        <div class="rule-examples">
                            <div class="example-label">‚úì Valid:</div>
                            <div class="example-good">condition,reporting_jurisdiction,case_status,report_date,illness_onset_date,...</div>
                            <div class="example-label">‚úó Invalid:</div>
                            <div class="example-bad">condition,reporting_jurisdiction (missing required fields)</div>
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
REQUIRED_FIELDS = ['condition', 'reporting_jurisdiction',
                   'case_status', 'report_date', 'illness_onset_date']

missing = [f for f in REQUIRED_FIELDS if f not in df.columns]
if missing:
    result.add_error(f"Missing: {', '.join(missing)}")
                        </div>
                    </div>

                    <div class="rule-card error">
                        <div class="rule-header">
                            <span class="rule-title">1.2 Required Values Cannot Be Empty</span>
                            <span class="severity-badge severity-error">ERROR</span>
                        </div>
                        <div class="rule-description">
                            Required fields cannot contain null, blank, or placeholder values (N/A, TBD, unknown, etc.).
                            Each case must have valid data for all mandatory elements.
                        </div>
                        <div class="rule-examples">
                            <div class="example-label">‚úó Invalid placeholders:</div>
                            <div class="example-bad">condition = "N/A"  or  "TBD"  or  ""  or  "unknown"</div>
                        </div>
                    </div>

                    <div class="rule-card warning">
                        <div class="rule-header">
                            <span class="rule-title">1.3 Conditional Completeness</span>
                            <span class="severity-badge severity-warning">WARNING</span>
                        </div>
                        <div class="rule-description">
                            If patient died (died=Y), date of death should be provided. If hospitalized (hospitalized=Y),
                            admission date expected. Dependent fields should be complete when primary condition is met.
                        </div>
                    </div>

                    <div class="rule-card warning">
                        <div class="rule-header">
                            <span class="rule-title">1.4 Optional Field Completeness Rate</span>
                            <span class="severity-badge severity-warning">WARNING</span>
                        </div>
                        <div class="rule-description">
                            Tracks completeness of optional but important fields (age, sex, race, ethnicity).
                            Warns if >20% missing, as this impacts epidemiological analysis.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Accuracy -->
    <div class="accordion" id="accuracy">
        <div class="accordion-header" onclick="toggleAccordion(this)">
            <div class="accordion-title">
                <span class="accordion-icon">üéØ</span>
                <span>2. ACCURACY - Correct Values</span>
            </div>
            <span class="accordion-toggle">‚ñº</span>
        </div>
        <div class="accordion-content">
            <div class="accordion-body">
                <p style="color: #666; margin-bottom: 1.5rem;">
                    Data values must accurately represent real-world information within plausible ranges.
                </p>

                <div class="rule-grid">
                    <div class="rule-card error">
                        <div class="rule-header">
                            <span class="rule-title">2.1 Age Plausibility</span>
                            <span class="severity-badge severity-error">ERROR</span>
                        </div>
                        <div class="rule-description">
                            Age must be 0-120 years. Values outside this range are biologically implausible.
                            Age unit must match value (years, months, days, hours).
                        </div>
                        <div class="rule-examples">
                            <div class="example-label">‚úì Valid:</div>
                            <div class="example-good">age=25, unit='a' (years)  |  age=6, unit='mo' (months)</div>
                            <div class="example-label">‚úó Invalid:</div>
                            <div class="example-bad">age=999  |  age=-5  |  age=150</div>
                        </div>
                    </div>

                    <div class="rule-card warning">
                        <div class="rule-header">
                            <span class="rule-title">2.2 Outlier Detection</span>
                            <span class="severity-badge severity-warning">WARNING</span>
                        </div>
                        <div class="rule-description">
                            Statistical outliers detected using IQR method (values >3x interquartile range from median).
                            May indicate data entry errors or unusual cases requiring verification.
                        </div>
                    </div>

                    <div class="rule-card error">
                        <div class="rule-header">
                            <span class="rule-title">2.3 Numeric Precision</span>
                            <span class="severity-badge severity-warning">WARNING</span>
                        </div>
                        <div class="rule-description">
                            Excessive decimal places (>2 for percentages, >4 for lab values) may indicate calculation
                            errors or inappropriate precision for biological measurements.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Consistency -->
    <div class="accordion" id="consistency">
        <div class="accordion-header" onclick="toggleAccordion(this)">
            <div class="accordion-title">
                <span class="accordion-icon">üîó</span>
                <span>3. CONSISTENCY - Logical Coherence</span>
            </div>
            <span class="accordion-toggle">‚ñº</span>
        </div>
        <div class="accordion-content">
            <div class="accordion-body">
                <p style="color: #666; margin-bottom: 1.5rem;">
                    Related data elements must not contradict each other. Cross-field logic must be maintained.
                </p>

                <div class="rule-grid">
                    <div class="rule-card error">
                        <div class="rule-header">
                            <span class="rule-title">3.1 Date Sequence Logic</span>
                            <span class="severity-badge severity-error">ERROR</span>
                        </div>
                        <div class="rule-description">
                            Illness onset date must be ‚â§ report date. Report date must be ‚â§ investigation start date.
                            Birth date must be before all other dates. Logical temporal sequence must be maintained.
                        </div>
                        <div class="rule-examples">
                            <div class="example-label">‚úì Valid:</div>
                            <div class="example-good">onset: 2026-01-10 ‚Üí report: 2026-01-15 ‚Üí investigation: 2026-01-16</div>
                            <div class="example-label">‚úó Invalid:</div>
                            <div class="example-bad">onset: 2026-01-20 ‚Üí report: 2026-01-15 (onset after report)</div>
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
if onset_date > report_date:
    result.add_error(
        "Illness onset cannot be after report date",
        row=idx+2,
        field='illness_onset_date'
    )
                        </div>
                    </div>

                    <div class="rule-card warning">
                        <div class="rule-header">
                            <span class="rule-title">3.2 Hospitalization Death Logic</span>
                            <span class="severity-badge severity-warning">WARNING</span>
                        </div>
                        <div class="rule-description">
                            If patient died (died=Y) but not hospitalized (hospitalized=N), this is unusual and warrants
                            verification. Most deaths occur in hospital settings.
                        </div>
                    </div>

                    <div class="rule-card error">
                        <div class="rule-header">
                            <span class="rule-title">3.3 Age-Condition Consistency</span>
                            <span class="severity-badge severity-warning">WARNING</span>
                        </div>
                        <div class="rule-description">
                            Some conditions have age-specific patterns (e.g., congenital conditions in adults,
                            age-related diseases in children). Flags inconsistencies for review.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Additional dimensions continued... (Validity, Timeliness, Uniqueness) -->
    <!-- Truncated for brevity but following same pattern -->

</div>

<!-- Mumps System Content (Similar structure) -->
<div id="mumps-content" class="system-content">
    <h3 style="color: #1e3a5f; margin: 2rem 0 1rem;">Mumps Disease Surveillance (MMG v1.0.2)</h3>
    <p style="color: #666; margin-bottom: 2rem;">
        Mumps-specific validations with clinical and laboratory criteria...
    </p>
    <!-- Similar accordion structure for Mumps -->
</div>

<!-- NREVSS System Content -->
<div id="nrevss-content" class="system-content">
    <h3 style="color: #1e3a5f; margin: 2rem 0 1rem;">NREVSS (Laboratory Surveillance)</h3>
    <p style="color: #666; margin-bottom: 2rem;">
        Laboratory data quality validations for respiratory virus surveillance...
    </p>
    <!-- Similar accordion structure for NREVSS -->
</div>

<div style="text-align: center; margin: 3rem 0;">
    <a href="/" class="btn btn-secondary">Back to Dashboard</a>
</div>

<script>
// Toggle accordion
function toggleAccordion(header) {
    const content = header.nextElementSibling;
    const toggle = header.querySelector('.accordion-toggle');

    header.classList.toggle('active');
    content.classList.toggle('show');
    toggle.classList.toggle('active');
}

// Toggle code blocks
function toggleCode(button) {
    const codeBlock = button.nextElementSibling;
    codeBlock.classList.toggle('show');
    button.textContent = codeBlock.classList.contains('show') ? 'Hide Code' : 'Show Code';
}

// Switch between systems
function showSystem(systemId) {
    // Update tabs
    document.querySelectorAll('.system-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    event.target.classList.add('active');

    // Update content
    document.querySelectorAll('.system-content').forEach(content => {
        content.classList.remove('active');
    });
    document.getElementById(systemId + '-content').classList.add('active');
}

// Scroll to dimension
function scrollToDimension(dimensionId) {
    const element = document.getElementById(dimensionId);
    if (element) {
        element.scrollIntoView({ behavior: 'smooth', block: 'start' });

        // Open the accordion if closed
        const header = element.querySelector('.accordion-header');
        if (header && !header.classList.contains('active')) {
            toggleAccordion(header);
        }
    }
}

// Search/filter function
function filterContent() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const ruleCards = document.querySelectorAll('.rule-card');

    ruleCards.forEach(card => {
        const text = card.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
            card.style.display = 'block';
            card.style.animation = 'slideDown 0.3s ease-out';
        } else {
            card.style.display = 'none';
        }
    });

    // If searching, open all accordions
    if (searchTerm.length > 2) {
        document.querySelectorAll('.accordion-header:not(.active)').forEach(header => {
            toggleAccordion(header);
        });
    }
}
</script>
{% endblock %}
