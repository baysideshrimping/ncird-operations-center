{% extends "base.html" %}

{% block title %}Validation Documentation - NCIRD{% endblock %}

{% block extra_css %}
<style>
    .doc-intro {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 8px;
        margin-bottom: 2rem;
    }

    .doc-intro h1 {
        color: white;
        margin-bottom: 1rem;
    }

    .quality-dimensions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 1rem;
        margin: 2rem 0;
    }

    .dimension-card {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-top: 4px solid #2c5282;
        cursor: pointer;
        transition: transform 0.2s;
    }

    .dimension-card:hover {
        transform: translateY(-4px);
    }

    .dimension-icon {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
    }

    .dimension-name {
        font-weight: 600;
        color: #1e3a5f;
        margin-bottom: 0.25rem;
    }

    .dimension-desc {
        font-size: 0.85rem;
        color: #666;
    }

    /* Accordion styles */
    .accordion {
        background: white;
        border-radius: 8px;
        margin-bottom: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .accordion-header {
        background: #f8f9fa;
        padding: 1.5rem;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-left: 4px solid #2c5282;
        transition: background 0.3s;
    }

    .accordion-header:hover {
        background: #e9ecef;
    }

    .accordion-header.active {
        background: #2c5282;
        color: white;
    }

    .accordion-title {
        font-size: 1.25rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .accordion-icon {
        font-size: 1.5rem;
    }

    .accordion-toggle {
        font-size: 1.5rem;
        transition: transform 0.3s;
    }

    .accordion-toggle.active {
        transform: rotate(180deg);
    }

    .accordion-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
    }

    .accordion-content.show {
        max-height: 5000px;
        transition: max-height 0.5s ease-in;
    }

    .accordion-body {
        padding: 2rem;
    }

    /* System selector tabs */
    .system-tabs {
        display: flex;
        gap: 1rem;
        margin: 2rem 0;
        flex-wrap: wrap;
    }

    .system-tab {
        padding: 0.75rem 1.5rem;
        background: #e9ecef;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
    }

    .system-tab:hover {
        background: #dee2e6;
    }

    .system-tab.active {
        background: #2c5282;
        color: white;
    }

    .system-content {
        display: none;
    }

    .system-content.active {
        display: block;
    }

    /* Validation rule cards */
    .rule-grid {
        display: grid;
        gap: 1rem;
        margin: 1rem 0;
    }

    .rule-card {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 6px;
        border-left: 4px solid #28a745;
    }

    .rule-card.warning {
        border-left-color: #ffc107;
    }

    .rule-card.error {
        border-left-color: #dc3545;
    }

    .rule-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .rule-title {
        font-weight: 600;
        color: #1e3a5f;
        font-size: 1.05rem;
    }

    .severity-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .severity-error { background: #dc3545; color: white; }
    .severity-warning { background: #ffc107; color: #333; }
    .severity-info { background: #17a2b8; color: white; }

    .rule-description {
        color: #333;
        line-height: 1.6;
        margin-bottom: 1rem;
    }

    .rule-examples {
        background: white;
        padding: 1rem;
        border-radius: 4px;
        margin-top: 1rem;
    }

    .example-label {
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #666;
    }

    .example-good {
        color: #28a745;
        font-family: 'Courier New', monospace;
        padding: 0.5rem;
        background: #d4edda;
        border-radius: 4px;
        margin: 0.5rem 0;
        font-size: 0.9rem;
    }

    .example-bad {
        color: #dc3545;
        font-family: 'Courier New', monospace;
        padding: 0.5rem;
        background: #f8d7da;
        border-radius: 4px;
        margin: 0.5rem 0;
        font-size: 0.9rem;
    }

    .code-toggle {
        background: #2c5282;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        margin-top: 0.5rem;
        transition: background 0.3s;
    }

    .code-toggle:hover {
        background: #1e3a5f;
    }

    .code-block {
        display: none;
        background: #282c34;
        color: #abb2bf;
        padding: 1rem;
        border-radius: 4px;
        margin-top: 1rem;
        overflow-x: auto;
        font-family: 'Courier New', monospace;
        font-size: 0.85rem;
        line-height: 1.5;
    }

    .code-block.show {
        display: block;
        animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .search-box {
        margin: 2rem 0;
        position: relative;
    }

    .search-input {
        width: 100%;
        padding: 1rem 1rem 1rem 3rem;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 1rem;
    }

    .search-input:focus {
        outline: none;
        border-color: #2c5282;
    }

    .search-icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #666;
        font-size: 1.2rem;
    }

    .framework-info {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 1rem 1.5rem;
        margin: 2rem 0;
        border-radius: 4px;
    }

    .framework-info strong {
        color: #856404;
    }
</style>
{% endblock %}

{% block content %}
<!-- Intro Section -->
<div class="doc-intro">
    <h1>üìö Validation Documentation</h1>
    <p style="font-size: 1.1rem; margin-bottom: 0;">
        Comprehensive data quality validation framework based on ISO 8000, CDC NNDSS guidelines,
        and WHO surveillance standards.
    </p>
</div>

<!-- Framework Info -->
<div class="framework-info">
    <strong>üéØ Data Quality Framework:</strong> All validations are organized according to the
    <strong>Six Data Quality Dimensions</strong> - industry-standard criteria for healthcare data quality
    established by ISO 8000, CDC, and WHO.
</div>

<!-- Data Quality Dimensions Overview -->
<h2 style="color: #1e3a5f; margin-bottom: 1rem;">Six Data Quality Dimensions</h2>
<div class="quality-dimensions">
    <div class="dimension-card" onclick="scrollToDimension('completeness')">
        <div class="dimension-icon">‚úì</div>
        <div class="dimension-name">Completeness</div>
        <div class="dimension-desc">All required data present</div>
    </div>
    <div class="dimension-card" onclick="scrollToDimension('accuracy')">
        <div class="dimension-icon">üéØ</div>
        <div class="dimension-name">Accuracy</div>
        <div class="dimension-desc">Values are correct</div>
    </div>
    <div class="dimension-card" onclick="scrollToDimension('consistency')">
        <div class="dimension-icon">üîó</div>
        <div class="dimension-name">Consistency</div>
        <div class="dimension-desc">No contradictions</div>
    </div>
    <div class="dimension-card" onclick="scrollToDimension('validity')">
        <div class="dimension-icon">‚úîÔ∏è</div>
        <div class="dimension-name">Validity</div>
        <div class="dimension-desc">Conforms to formats</div>
    </div>
    <div class="dimension-card" onclick="scrollToDimension('timeliness')">
        <div class="dimension-icon">‚è±Ô∏è</div>
        <div class="dimension-name">Timeliness</div>
        <div class="dimension-desc">Reported on time</div>
    </div>
    <div class="dimension-card" onclick="scrollToDimension('uniqueness')">
        <div class="dimension-icon">üîë</div>
        <div class="dimension-name">Uniqueness</div>
        <div class="dimension-desc">No duplicates</div>
    </div>
</div>

<!-- Search -->
<div class="search-box">
    <span class="search-icon">üîç</span>
    <input type="text" class="search-input" id="searchInput"
           placeholder="Search validations (e.g., 'date', 'jurisdiction', 'lab result')..."
           onkeyup="filterContent()">
</div>

<!-- System Selector -->
<h2 style="color: #1e3a5f; margin: 2rem 0 1rem 0;">Select Data Stream</h2>
<div class="system-tabs">
    <button class="system-tab active" onclick="showSystem('nnad')">NNAD</button>
    <button class="system-tab" onclick="showSystem('mumps')">Mumps</button>
    <button class="system-tab" onclick="showSystem('nrevss')">NREVSS</button>
</div>

<!-- NNAD System Content -->
<div id="nnad-content" class="system-content active">
    <h3 style="color: #1e3a5f; margin: 2rem 0 1rem;">NNAD (National Notifiable Diseases Surveillance System)</h3>

    <!-- Completeness -->
    <div class="accordion" id="completeness">
        <div class="accordion-header" onclick="toggleAccordion(this)">
            <div class="accordion-title">
                <span class="accordion-icon">‚úì</span>
                <span>1. COMPLETENESS - Required Data Elements</span>
            </div>
            <span class="accordion-toggle">‚ñº</span>
        </div>
        <div class="accordion-content">
            <div class="accordion-body">
                <p style="color: #666; margin-bottom: 1.5rem;">
                    Ensures all mandatory fields are present and populated. Missing data reduces surveillance effectiveness.
                </p>

                <div class="rule-grid">
                    <div class="rule-card error" id="nnad-completeness-1-1">
                        <div class="rule-header">
                            <span class="rule-title">1.1 Required Fields Must Exist</span>
                            <span class="severity-badge severity-error">ERROR</span>
                        </div>
                        <div class="rule-description">
                            File must contain all mandatory columns: condition, reporting_jurisdiction, case_status,
                            report_date, illness_onset_date. Missing columns prevent submission.
                        </div>
                        <div class="rule-examples">
                            <div class="example-label">‚úì Valid:</div>
                            <div class="example-good">condition,reporting_jurisdiction,case_status,report_date,illness_onset_date,...</div>
                            <div class="example-label">‚úó Invalid:</div>
                            <div class="example-bad">condition,reporting_jurisdiction (missing required fields)</div>
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
REQUIRED_FIELDS = ['condition', 'reporting_jurisdiction',
                   'case_status', 'report_date', 'illness_onset_date']

missing = [f for f in REQUIRED_FIELDS if f not in df.columns]
if missing:
    result.add_error(f"Missing: {', '.join(missing)}")
                        </div>
                    </div>

                    <div class="rule-card error" id="nnad-completeness-1-2">
                        <div class="rule-header">
                            <span class="rule-title">1.2 Required Values Cannot Be Empty</span>
                            <span class="severity-badge severity-error">ERROR</span>
                        </div>
                        <div class="rule-description">
                            Required fields cannot contain null, blank, or placeholder values (N/A, TBD, unknown, etc.).
                            Each case must have valid data for all mandatory elements.
                        </div>
                        <div class="rule-examples">
                            <div class="example-label">‚úó Invalid placeholders:</div>
                            <div class="example-bad">condition = "N/A"  or  "TBD"  or  ""  or  "unknown"</div>
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
for field in REQUIRED_FIELDS:
    if pd.isna(df[field].iloc[idx]) or not str(df[field].iloc[idx]).strip():
        result.add_error(
            f"Required field '{field}' is empty",
            row=idx+2,
            field=field,
            doc_link='#nnad-completeness-1-2'
        )
                        </div>
                    </div>

                    <div class="rule-card warning" id="nnad-completeness-1-3">
                        <div class="rule-header">
                            <span class="rule-title">1.3 Conditional Completeness</span>
                            <span class="severity-badge severity-warning">WARNING</span>
                        </div>
                        <div class="rule-description">
                            If patient died (died=Y), date of death should be provided. If hospitalized (hospitalized=Y),
                            admission date expected. Dependent fields should be complete when primary condition is met.
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
if died == 'Y' and 'death_date' in df.columns:
    death_date = df['death_date'].iloc[idx]
    if pd.isna(death_date) or not str(death_date).strip():
        result.add_warning(
            "Patient died but death_date is missing",
            row=idx+2,
            field='death_date',
            doc_link='#nnad-completeness-1-3'
        )
                        </div>
                    </div>

                    <div class="rule-card warning" id="nnad-completeness-1-4">
                        <div class="rule-header">
                            <span class="rule-title">1.4 Optional Field Completeness Rate</span>
                            <span class="severity-badge severity-warning">WARNING</span>
                        </div>
                        <div class="rule-description">
                            Tracks completeness of optional but important fields (age, sex, race, ethnicity).
                            Warns if >20% missing, as this impacts epidemiological analysis.
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
important_fields = ['age_at_case_investigation', 'sex', 'race', 'ethnicity']
for field in important_fields:
    if field in df.columns:
        missing_pct = (df[field].isna().sum() / len(df)) * 100
        if missing_pct > 20:
            result.add_warning(
                f"Field '{field}' is {missing_pct:.1f}% incomplete",
                doc_link='#nnad-completeness-1-4'
            )
                        </div>
                    </div>

                    <div class="rule-card warning" id="nnad-completeness-1-5">
                        <div class="rule-header">
                            <span class="rule-title">1.5 Pregnancy Status for Reproductive-Age Females</span>
                            <span class="severity-badge severity-warning">WARNING</span>
                        </div>
                        <div class="rule-description">
                            For females aged 12-50 years, pregnancy status should be documented (Y/N/U/NA).
                            Missing pregnancy status impacts risk assessment for teratogenic diseases.
                            If pregnant=Y, trimester should also be recorded.
                        </div>
                        <div class="rule-examples">
                            <div class="example-label">‚úì Complete:</div>
                            <div class="example-good">Female age 28, pregnant=Y, trimester=2</div>
                            <div class="example-label">‚ö†Ô∏è Incomplete:</div>
                            <div class="example-bad">Female age 28, pregnant=blank</div>
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
if sex == 'F' and 12 <= age_val <= 50 and not pregnant:
    result.add_warning(
        f"Pregnancy status missing for female age {age_val}",
        row=idx+2,
        field='pregnant',
        doc_link='#nnad-completeness-1-5'
    )

if pregnant == 'Y' and not trimester:
    result.add_warning(
        "Pregnancy = Yes but trimester is missing",
        row=idx+2,
        field='pregnancy_trimester',
        doc_link='#nnad-completeness-1-5'
    )
                        </div>
                    </div>

                    <div class="rule-card warning" id="nnad-completeness-1-6">
                        <div class="rule-header">
                            <span class="rule-title">1.6 Outbreak Name When Outbreak-Associated</span>
                            <span class="severity-badge severity-warning">WARNING</span>
                        </div>
                        <div class="rule-description">
                            If outbreak_associated=Y, outbreak_name field should identify the specific outbreak.
                            Essential for linking cases to outbreak investigations.
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
if outbreak_str == 'Y' and 'outbreak_name' in df.columns:
    name = df['outbreak_name'].iloc[idx]
    if pd.isna(name) or not str(name).strip():
        result.add_warning(
            "Outbreak-associated but outbreak_name is missing",
            row=idx+2,
            field='outbreak_name',
            doc_link='#nnad-completeness-1-6'
        )
                        </div>
                    </div>

                    <div class="rule-card warning" id="nnad-completeness-1-7">
                        <div class="rule-header">
                            <span class="rule-title">1.7 Country of Exposure for Imported Cases</span>
                            <span class="severity-badge severity-warning">WARNING</span>
                        </div>
                        <div class="rule-description">
                            If import_status=IMP (Imported), country_of_exposure should document where patient acquired infection.
                            Critical for tracking international disease transmission patterns.
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
if status_str == 'IMP' and 'country_of_exposure' in df.columns:
    country = df['country_of_exposure'].iloc[idx]
    if pd.isna(country) or not str(country).strip():
        result.add_warning(
            "Import status = Imported but country_of_exposure missing",
            row=idx+2,
            field='country_of_exposure',
            doc_link='#nnad-completeness-1-7'
        )
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Accuracy -->
    <div class="accordion" id="accuracy">
        <div class="accordion-header" onclick="toggleAccordion(this)">
            <div class="accordion-title">
                <span class="accordion-icon">üéØ</span>
                <span>2. ACCURACY - Correct Values</span>
            </div>
            <span class="accordion-toggle">‚ñº</span>
        </div>
        <div class="accordion-content">
            <div class="accordion-body">
                <p style="color: #666; margin-bottom: 1.5rem;">
                    Data values must accurately represent real-world information within plausible ranges.
                </p>

                <div class="rule-grid">
                    <div class="rule-card error" id="nnad-accuracy-2-1">
                        <div class="rule-header">
                            <span class="rule-title">2.1 Age Plausibility</span>
                            <span class="severity-badge severity-error">ERROR</span>
                        </div>
                        <div class="rule-description">
                            Age must be 0-120 years. Values outside this range are biologically implausible.
                            Age unit must match value (years, months, days, hours).
                        </div>
                        <div class="rule-examples">
                            <div class="example-label">‚úì Valid:</div>
                            <div class="example-good">age=25, unit='a' (years)  |  age=6, unit='mo' (months)</div>
                            <div class="example-label">‚úó Invalid:</div>
                            <div class="example-bad">age=999  |  age=-5  |  age=150</div>
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
if 'age_at_case_investigation' in df.columns:
    for idx, age in enumerate(df['age_at_case_investigation']):
        if pd.notna(age):
            is_valid, msg = validate_integer(age, min_val=0, max_val=120)
            if not is_valid:
                result.add_error(
                    f"Invalid age: {msg}",
                    row=idx+2,
                    field='age_at_case_investigation',
                    doc_link='#nnad-accuracy-2-1'
                )
                        </div>
                    </div>

                    <div class="rule-card warning" id="nnad-accuracy-2-2">
                        <div class="rule-header">
                            <span class="rule-title">2.2 Outlier Detection</span>
                            <span class="severity-badge severity-warning">WARNING</span>
                        </div>
                        <div class="rule-description">
                            Statistical outliers detected using IQR method (values >3x interquartile range from median).
                            May indicate data entry errors or unusual cases requiring verification.
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
# IQR outlier detection
Q1 = df[field].quantile(0.25)
Q3 = df[field].quantile(0.75)
IQR = Q3 - Q1
lower_bound = Q1 - 3 * IQR
upper_bound = Q3 + 3 * IQR

if value < lower_bound or value > upper_bound:
    result.add_warning(
        f"Statistical outlier detected: {value}",
        row=idx+2,
        field=field,
        doc_link='#nnad-accuracy-2-2'
    )
                        </div>
                    </div>

                    <div class="rule-card error" id="nnad-accuracy-2-3">
                        <div class="rule-header">
                            <span class="rule-title">2.3 Numeric Precision</span>
                            <span class="severity-badge severity-warning">WARNING</span>
                        </div>
                        <div class="rule-description">
                            Excessive decimal places (>2 for percentages, >4 for lab values) may indicate calculation
                            errors or inappropriate precision for biological measurements.
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
if isinstance(value, float):
    decimal_places = len(str(value).split('.')[-1]) if '.' in str(value) else 0

    if field_type == 'percentage' and decimal_places > 2:
        result.add_warning(
            f"Excessive precision: {value} ({decimal_places} decimals)",
            row=idx+2,
            field=field,
            doc_link='#nnad-accuracy-2-3'
        )
                        </div>
                    </div>

                    <div class="rule-card error" id="nnad-accuracy-2-4">
                        <div class="rule-header">
                            <span class="rule-title">2.4 Vaccination Dose Count Plausibility</span>
                            <span class="severity-badge severity-error">ERROR</span>
                        </div>
                        <div class="rule-description">
                            Vaccination doses must be 0-10. Values >10 likely indicate data entry errors.
                            Most vaccines require ‚â§5 doses for full series.
                        </div>
                        <div class="rule-examples">
                            <div class="example-label">‚úì Valid:</div>
                            <div class="example-good">vaccination_doses: 2 (MMR standard series)</div>
                            <div class="example-label">‚úó Invalid:</div>
                            <div class="example-bad">vaccination_doses: 25 (implausible)</div>
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
dose_count = int(doses)
if dose_count < 0 or dose_count > 10:
    result.add_error(
        f"Implausible vaccination dose count: {dose_count}",
        field='vaccination_doses',
        doc_link='#nnad-accuracy-2-4'
    )
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Consistency -->
    <div class="accordion" id="consistency">
        <div class="accordion-header" onclick="toggleAccordion(this)">
            <div class="accordion-title">
                <span class="accordion-icon">üîó</span>
                <span>3. CONSISTENCY - Logical Coherence</span>
            </div>
            <span class="accordion-toggle">‚ñº</span>
        </div>
        <div class="accordion-content">
            <div class="accordion-body">
                <p style="color: #666; margin-bottom: 1.5rem;">
                    Related data elements must not contradict each other. Cross-field logic must be maintained.
                </p>

                <div class="rule-grid">
                    <div class="rule-card error" id="nnad-consistency-3-1">
                        <div class="rule-header">
                            <span class="rule-title">3.1 Date Sequence Logic</span>
                            <span class="severity-badge severity-error">ERROR</span>
                        </div>
                        <div class="rule-description">
                            Illness onset date must be ‚â§ report date. Report date must be ‚â§ investigation start date.
                            Birth date must be before all other dates. Logical temporal sequence must be maintained.
                        </div>
                        <div class="rule-examples">
                            <div class="example-label">‚úì Valid:</div>
                            <div class="example-good">onset: 2026-01-10 ‚Üí report: 2026-01-15 ‚Üí investigation: 2026-01-16</div>
                            <div class="example-label">‚úó Invalid:</div>
                            <div class="example-bad">onset: 2026-01-20 ‚Üí report: 2026-01-15 (onset after report)</div>
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
if onset_date > report_date:
    result.add_error(
        "Illness onset cannot be after report date",
        row=idx+2,
        field='illness_onset_date'
    )
                        </div>
                    </div>

                    <div class="rule-card warning" id="nnad-consistency-3-2">
                        <div class="rule-header">
                            <span class="rule-title">3.2 Hospitalization Death Logic</span>
                            <span class="severity-badge severity-warning">WARNING</span>
                        </div>
                        <div class="rule-description">
                            If patient died (died=Y) but not hospitalized (hospitalized=N), this is unusual and warrants
                            verification. Most deaths occur in hospital settings.
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
if 'died' in df.columns and 'hospitalized' in df.columns:
    died = str(df['died'].iloc[idx]).upper()
    hospitalized = str(df['hospitalized'].iloc[idx]).upper()

    if died == 'Y' and hospitalized == 'N':
        result.add_warning(
            "Patient died but not hospitalized - verify data",
            row=idx+2,
            field='died',
            doc_link='#nnad-consistency-3-2'
        )
                        </div>
                    </div>

                    <div class="rule-card error" id="nnad-consistency-3-3">
                        <div class="rule-header">
                            <span class="rule-title">3.3 Age-Condition Consistency</span>
                            <span class="severity-badge severity-warning">WARNING</span>
                        </div>
                        <div class="rule-description">
                            Some conditions have age-specific patterns (e.g., congenital conditions in adults,
                            age-related diseases in children). Flags inconsistencies for review.
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
# Age-specific condition patterns
pediatric_conditions = ['Congenital Rubella', 'Neonatal Tetanus']
adult_conditions = ['Shingles', 'Legionellosis']

if condition in pediatric_conditions and age_val > 18:
    result.add_warning(
        f"Pediatric condition in adult (age {age_val})",
        row=idx+2,
        field='condition',
        doc_link='#nnad-consistency-3-3'
    )
                        </div>
                    </div>

                    <div class="rule-card error" id="nnad-consistency-3-4">
                        <div class="rule-header">
                            <span class="rule-title">3.4 Pregnancy Status vs Sex</span>
                            <span class="severity-badge severity-error">ERROR</span>
                        </div>
                        <div class="rule-description">
                            Pregnancy status = Yes is only valid for sex = Female.
                            Male patients cannot have pregnant=Y.
                        </div>
                        <div class="rule-examples">
                            <div class="example-label">‚úó Invalid:</div>
                            <div class="example-bad">sex=M, pregnant=Y (contradiction)</div>
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
if 'sex' in df.columns:
    sex = str(df['sex'].iloc[idx]).upper()

    if pregnant == 'Y' and sex == 'M':
        result.add_error(
            "Pregnancy status = Yes for male patient",
            row=idx+2,
            field='pregnant',
            doc_link='#nnad-consistency-3-4'
        )
                        </div>
                    </div>

                    <div class="rule-card error" id="nnad-consistency-3-5">
                        <div class="rule-header">
                            <span class="rule-title">3.5 Vaccination Date Temporal Logic</span>
                            <span class="severity-badge severity-error">ERROR</span>
                        </div>
                        <div class="rule-description">
                            Vaccination dates must follow temporal logic: birth_date < vaccination_date < illness_onset_date.
                            Cannot vaccinate before birth or after illness onset.
                        </div>
                        <div class="rule-examples">
                            <div class="example-label">‚úì Valid:</div>
                            <div class="example-good">Birth: 1990-01-01 ‚Üí Vax: 2020-05-15 ‚Üí Onset: 2026-01-10</div>
                            <div class="example-label">‚úó Invalid:</div>
                            <div class="example-bad">Vax: 2026-01-15 ‚Üí Onset: 2026-01-10 (vax after onset)</div>
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
if vax_dt > onset_dt:
    result.add_error(
        f"Vaccination date after illness onset",
        field='vaccination_date_1',
        doc_link='#nnad-consistency-3-5'
    )
                        </div>
                    </div>

                    <div class="rule-card warning" id="nnad-consistency-3-6">
                        <div class="rule-header">
                            <span class="rule-title">3.6 Case Status vs Laboratory Data</span>
                            <span class="severity-badge severity-warning">WARNING</span>
                        </div>
                        <div class="rule-description">
                            Confirmed cases (410605003) should have supporting laboratory data.
                            If case_status=Confirmed but no lab results documented, verify classification criteria were met.
                        </div>
                        <div class="rule-examples">
                            <div class="example-label">‚úì Consistent:</div>
                            <div class="example-good">case_status=410605003 (Confirmed), lab_result=Positive</div>
                            <div class="example-label">‚ö†Ô∏è Verify:</div>
                            <div class="example-bad">case_status=410605003 (Confirmed), lab_result=blank</div>
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
if status == '410605003':  # Confirmed
    has_lab = False
    lab_fields = ['lab_result', 'specimen_collection_date', 'lab_test_type']

    for field in lab_fields:
        if field in df.columns and pd.notna(df[field].iloc[idx]):
            has_lab = True
            break

    if not has_lab:
        result.add_warning(
            "Confirmed case without laboratory data",
            row=idx+2,
            field='case_status',
            doc_link='#nnad-consistency-3-6'
        )
                        </div>
                    </div>

                    <div class="rule-card warning" id="nnad-consistency-3-7">
                        <div class="rule-header">
                            <span class="rule-title">3.7 Congenital Conditions Age Check</span>
                            <span class="severity-badge severity-warning">WARNING</span>
                        </div>
                        <div class="rule-description">
                            Congenital conditions (Congenital Rubella, Congenital Syphilis) are typically diagnosed in infants/young children.
                            Cases with age >2 years are flagged for verification.
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
congenital_conditions = ['Congenital Rubella', 'Congenital Syphilis']

if any(cond in condition for cond in congenital_conditions) and age_val > 2:
    result.add_warning(
        f"Congenital condition in adult (age {age_val})",
        row=idx+2,
        field='condition',
        doc_link='#nnad-consistency-3-7'
    )
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Validity -->
    <div class="accordion" id="validity">
        <div class="accordion-header" onclick="toggleAccordion(this)">
            <div class="accordion-title">
                <span class="accordion-icon">‚úîÔ∏è</span>
                <span>4. VALIDITY - Format and Code Compliance</span>
            </div>
            <span class="accordion-toggle">‚ñº</span>
        </div>
        <div class="accordion-content">
            <div class="accordion-body">
                <p style="color: #666; margin-bottom: 1.5rem;">
                    Data must conform to defined formats, code sets, and standards (SNOMED CT, FIPS codes, ISO 8601 dates).
                </p>

                <div class="rule-grid">
                    <div class="rule-card error" id="nnad-validity-4-1">
                        <div class="rule-header">
                            <span class="rule-title">4.1 SNOMED CT Case Status Codes</span>
                            <span class="severity-badge severity-error">ERROR</span>
                        </div>
                        <div class="rule-description">
                            Case status must use valid SNOMED CT codes from the approved value set.
                            Free text or numeric codes not in the value set are rejected.
                        </div>
                        <div class="rule-examples">
                            <div class="example-label">‚úì Valid codes:</div>
                            <div class="example-good">410605003 (Confirmed) | 2931005 (Probable) | 415684004 (Suspected) | PHC1464 (Not a case)</div>
                            <div class="example-label">‚úó Invalid:</div>
                            <div class="example-bad">"confirmed" | "probable" | 999 | blank</div>
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
CASE_STATUS_CODES = {
    '410605003': 'Confirmed',
    '2931005': 'Probable',
    '415684004': 'Suspected',
    'PHC1464': 'Not a case'
}

status_str = str(status).strip()
if status_str not in CASE_STATUS_CODES:
    result.add_error("Invalid case status code", field='case_status')
                        </div>
                    </div>

                    <div class="rule-card error" id="nnad-validity-4-2">
                        <div class="rule-header">
                            <span class="rule-title">4.2 Jurisdiction Codes (FIPS)</span>
                            <span class="severity-badge severity-error">ERROR</span>
                        </div>
                        <div class="rule-description">
                            Reporting jurisdiction must be a valid 2-letter US state/territory abbreviation.
                            Includes 50 states + DC, PR, VI, GU, AS, MP.
                        </div>
                        <div class="rule-examples">
                            <div class="example-label">‚úì Valid:</div>
                            <div class="example-good">CA, TX, NY, DC, PR, VI</div>
                            <div class="example-label">‚úó Invalid:</div>
                            <div class="example-bad">California | Cal | 06 | ZZ</div>
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
if 'reporting_jurisdiction' in df.columns:
    state_info = validate_state_code(jurisdiction, 'abbr')
    if not state_info:
        result.add_error(
            f"Invalid jurisdiction code: {jurisdiction}",
            row=idx+2,
            field='reporting_jurisdiction',
            doc_link='#nnad-validity-4-2'
        )
                        </div>
                    </div>

                    <div class="rule-card error" id="nnad-validity-4-3">
                        <div class="rule-header">
                            <span class="rule-title">4.3 Date Format (ISO 8601)</span>
                            <span class="severity-badge severity-error">ERROR</span>
                        </div>
                        <div class="rule-description">
                            All dates must follow YYYY-MM-DD format (ISO 8601 standard).
                            Other formats (MM/DD/YYYY, DD-MMM-YYYY) are rejected for consistency.
                        </div>
                        <div class="rule-examples">
                            <div class="example-label">‚úì Valid:</div>
                            <div class="example-good">2026-01-15 | 2025-12-31</div>
                            <div class="example-label">‚úó Invalid:</div>
                            <div class="example-bad">01/15/2026 | 15-Jan-2026 | 1/15/26</div>
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
def validate_date_format(date_val):
    try:
        pd.to_datetime(date_val, format='%Y-%m-%d')
        return True, "Valid"
    except:
        return False, "Must be YYYY-MM-DD format"
                        </div>
                    </div>

                    <div class="rule-card warning" id="nnad-validity-4-4">
                        <div class="rule-header">
                            <span class="rule-title">4.4 Sex/Age Unit Code Sets</span>
                            <span class="severity-badge severity-warning">WARNING</span>
                        </div>
                        <div class="rule-description">
                            Sex must be M/F/U/O. Age unit must be a/mo/d/h (years/months/days/hours).
                            Warns if non-standard codes used.
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
SEX_CODES = {'M': 'Male', 'F': 'Female', 'U': 'Unknown', 'O': 'Other'}
AGE_UNITS = {'a': 'Years', 'mo': 'Months', 'd': 'Days', 'h': 'Hours'}

# Sex validation
is_valid, msg = validate_code_in_list(sex, SEX_CODES.keys(), "Sex")
if not is_valid:
    result.add_warning(
        msg,
        row=idx+2,
        field='sex',
        doc_link='#nnad-validity-4-4'
    )
                        </div>
                    </div>

                    <div class="rule-card error" id="nnad-validity-4-5">
                        <div class="rule-header">
                            <span class="rule-title">4.5 Pregnancy Status and Trimester Codes</span>
                            <span class="severity-badge severity-error">ERROR</span>
                        </div>
                        <div class="rule-description">
                            Pregnancy status must be Y/N/U/NA. Trimester must be 1/2/3/U.
                            Pregnancy outcome codes: LIVE_BIRTH, STILLBIRTH, MISCARRIAGE, ABORTION, ONGOING, UNK.
                        </div>
                        <div class="rule-examples">
                            <div class="example-label">‚úì Valid codes:</div>
                            <div class="example-good">pregnant=Y, trimester=2, outcome=LIVE_BIRTH</div>
                            <div class="example-label">‚úó Invalid:</div>
                            <div class="example-bad">pregnant="yes" (must be Y), trimester=second (must be 2)</div>
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
PREGNANCY_STATUS_CODES = {'Y': 'Yes', 'N': 'No', 'U': 'Unknown', 'NA': 'Not Applicable'}
TRIMESTER_CODES = {'1': 'First', '2': 'Second', '3': 'Third', 'U': 'Unknown'}

if pregnant and pregnant not in PREGNANCY_STATUS_CODES.keys():
    result.add_error(
        f"Invalid pregnancy status: {pregnant} (must be Y/N/U/NA)",
        row=idx+2,
        field='pregnant',
        doc_link='#nnad-validity-4-5'
    )

if trimester not in TRIMESTER_CODES.keys():
    result.add_error(
        f"Invalid trimester: {trimester} (must be 1/2/3/U)",
        row=idx+2,
        field='pregnancy_trimester',
        doc_link='#nnad-validity-4-5'
    )
                        </div>
                    </div>

                    <div class="rule-card error" id="nnad-validity-4-6">
                        <div class="rule-header">
                            <span class="rule-title">4.6 Outbreak Associated Y/N/U</span>
                            <span class="severity-badge severity-error">ERROR</span>
                        </div>
                        <div class="rule-description">
                            Outbreak_associated field must use Y (Yes), N (No), or U (Unknown).
                            Free text like "true", "outbreak", "yes" are invalid.
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
YNU_CODES = {'Y': 'Yes', 'N': 'No', 'U': 'Unknown'}

if outbreak_str not in YNU_CODES.keys():
    result.add_error(
        f"Invalid outbreak_associated: {outbreak} (must be Y/N/U)",
        row=idx+2,
        field='outbreak_associated',
        doc_link='#nnad-validity-4-6'
    )
                        </div>
                    </div>

                    <div class="rule-card error" id="nnad-validity-4-7">
                        <div class="rule-header">
                            <span class="rule-title">4.7 Import Status Codes</span>
                            <span class="severity-badge severity-error">ERROR</span>
                        </div>
                        <div class="rule-description">
                            Import status must use standard codes: IMP (Imported), IND (Import-related), INC (Indigenous), UNK (Unknown).
                            Indicates whether disease was acquired domestically or internationally.
                        </div>
                        <div class="rule-examples">
                            <div class="example-label">‚úì Valid:</div>
                            <div class="example-good">import_status=IMP (case traveled from endemic country)</div>
                            <div class="example-label">‚úó Invalid:</div>
                            <div class="example-bad">import_status="imported" (use IMP code)</div>
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
IMPORT_STATUS_CODES = {
    'IMP': 'Imported',
    'IND': 'Import-related',
    'INC': 'Indigenous',
    'UNK': 'Unknown'
}

if status_str not in IMPORT_STATUS_CODES.keys():
    result.add_error(
        f"Invalid import status: {status}",
        row=idx+2,
        field='import_status',
        doc_link='#nnad-validity-4-7'
    )
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Timeliness -->
    <div class="accordion" id="timeliness">
        <div class="accordion-header" onclick="toggleAccordion(this)">
            <div class="accordion-title">
                <span class="accordion-icon">‚è±Ô∏è</span>
                <span>5. TIMELINESS - Reporting Windows</span>
            </div>
            <span class="accordion-toggle">‚ñº</span>
        </div>
        <div class="accordion-content">
            <div class="accordion-body">
                <p style="color: #666; margin-bottom: 1.5rem;">
                    Data must be submitted within expected timeframes to enable timely public health response.
                </p>

                <div class="rule-grid">
                    <div class="rule-card warning" id="nnad-timeliness-5-1">
                        <div class="rule-header">
                            <span class="rule-title">5.1 Reporting Lag</span>
                            <span class="severity-badge severity-warning">WARNING</span>
                        </div>
                        <div class="rule-description">
                            Cases should be reported within 7 days of illness onset (varies by disease).
                            Long delays reduce outbreak detection capability.
                        </div>
                        <div class="rule-examples">
                            <div class="example-label">‚úì Acceptable:</div>
                            <div class="example-good">Onset: 2026-01-10 ‚Üí Report: 2026-01-12 (2 days)</div>
                            <div class="example-label">‚ö†Ô∏è Delayed:</div>
                            <div class="example-bad">Onset: 2025-12-01 ‚Üí Report: 2026-01-15 (45 days)</div>
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
onset_dt = pd.to_datetime(onset)
report_dt = pd.to_datetime(report)

lag_days = (report_dt - onset_dt).days

if lag_days > 14:
    result.add_warning(
        f"Reporting lag = {lag_days} days (>14 days may delay outbreak detection)",
        row=idx+2,
        field='report_date',
        doc_link='#nnad-timeliness-5-1'
    )
                        </div>
                    </div>

                    <div class="rule-card error" id="nnad-timeliness-5-2">
                        <div class="rule-header">
                            <span class="rule-title">5.2 Future Dates Prohibited</span>
                            <span class="severity-badge severity-error">ERROR</span>
                        </div>
                        <div class="rule-description">
                            Report dates, onset dates, and investigation dates cannot be in the future.
                            Future dates indicate data entry errors.
                        </div>
                        <div class="rule-examples">
                            <div class="example-label">‚úó Invalid:</div>
                            <div class="example-bad">report_date: 2027-01-01 (if today is 2026-02-03)</div>
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
from datetime import datetime

today = datetime.now().date()
date_val = pd.to_datetime(date_field).date()

if date_val > today:
    result.add_error(
        f"{field} is in the future: {date_val}",
        row=idx+2,
        field=field,
        doc_link='#nnad-timeliness-5-2'
    )
                        </div>
                    </div>

                    <div class="rule-card warning" id="nnad-timeliness-5-3">
                        <div class="rule-header">
                            <span class="rule-title">5.3 Stale Data Warning</span>
                            <span class="severity-badge severity-warning">WARNING</span>
                        </div>
                        <div class="rule-description">
                            Cases with onset dates >2 years old may be historical backfill or data cleanup.
                            Flagged for verification.
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
from datetime import datetime

today = datetime.now().date()
onset_dt = pd.to_datetime(onset).date()

years_old = (today - onset_dt).days / 365.25

if years_old > 2:
    result.add_warning(
        f"Onset date is {years_old:.1f} years old - historical case?",
        row=idx+2,
        field='illness_onset_date',
        doc_link='#nnad-timeliness-5-3'
    )
                        </div>
                    </div>

                    <div class="rule-card warning" id="nnad-timeliness-5-4">
                        <div class="rule-header">
                            <span class="rule-title">5.4 Investigation Timeliness</span>
                            <span class="severity-badge severity-warning">WARNING</span>
                        </div>
                        <div class="rule-description">
                            Case investigation should begin within 3 days of report date.
                            Report to health department should occur within 14 days of onset.
                            Delays may compromise contact tracing and outbreak control.
                        </div>
                        <div class="rule-examples">
                            <div class="example-label">‚úì Timely:</div>
                            <div class="example-good">Report: 2026-01-10 ‚Üí Investigation Start: 2026-01-11 (1 day)</div>
                            <div class="example-label">‚ö†Ô∏è Delayed:</div>
                            <div class="example-bad">Report: 2026-01-10 ‚Üí Investigation Start: 2026-01-20 (10 days)</div>
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
invest_lag = (invest_dt - report_dt).days

if invest_lag > 3:
    result.add_warning(
        f"Investigation started {invest_lag} days after report (recommend ‚â§3 days)",
        field='case_investigation_start_date',
        doc_link='#nnad-timeliness-5-4'
    )
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Uniqueness -->
    <div class="accordion" id="uniqueness">
        <div class="accordion-header" onclick="toggleAccordion(this)">
            <div class="accordion-title">
                <span class="accordion-icon">üîë</span>
                <span>6. UNIQUENESS - Duplicate Detection</span>
            </div>
            <span class="accordion-toggle">‚ñº</span>
        </div>
        <div class="accordion-content">
            <div class="accordion-body">
                <p style="color: #666; margin-bottom: 1.5rem;">
                    Each case should appear only once to prevent double-counting in incidence calculations.
                </p>

                <div class="rule-grid">
                    <div class="rule-card warning" id="nnad-uniqueness-6-1">
                        <div class="rule-header">
                            <span class="rule-title">6.1 Exact Duplicate Rows</span>
                            <span class="severity-badge severity-warning">WARNING</span>
                        </div>
                        <div class="rule-description">
                            Identical rows across all fields indicate copy-paste errors or accidental resubmission.
                            Warns if exact duplicates found.
                        </div>
                        <div class="rule-examples">
                            <div class="example-label">‚úó Duplicate:</div>
                            <div class="example-bad">
                                Row 2: CA, Mumps, 410605003, 2026-01-10<br>
                                Row 5: CA, Mumps, 410605003, 2026-01-10 (exact match)
                            </div>
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
# Check for exact duplicate rows
duplicates = df[df.duplicated(keep=False)]

if len(duplicates) > 0:
    dup_rows = duplicates.index.tolist()
    result.add_warning(
        f"Exact duplicate rows found: {len(duplicates)} rows",
        doc_link='#nnad-uniqueness-6-1'
    )
                        </div>
                    </div>

                    <div class="rule-card warning" id="nnad-uniqueness-6-2">
                        <div class="rule-header">
                            <span class="rule-title">6.2 Same Patient/Condition/Date</span>
                            <span class="severity-badge severity-warning">WARNING</span>
                        </div>
                        <div class="rule-description">
                            Multiple cases with same jurisdiction + condition + onset date may be duplicates.
                            Could also be legitimate outbreak cluster - requires verification.
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
has_dups, dup_indices, msg = check_duplicate_rows(
    df,
    subset=['reporting_jurisdiction', 'condition', 'illness_onset_date']
)
if has_dups:
    result.add_warning(
        f"Possible duplicate cases: {msg}",
        doc_link='#nnad-uniqueness-6-2'
    )
                        </div>
                    </div>

                    <div class="rule-card warning" id="nnad-uniqueness-6-3">
                        <div class="rule-header">
                            <span class="rule-title">6.3 Cross-Submission Deduplication</span>
                            <span class="severity-badge severity-warning">WARNING</span>
                        </div>
                        <div class="rule-description">
                            Checks for cases appearing in multiple weekly submissions.
                            May indicate re-reporting of same case vs. new episode.
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
# Cross-submission deduplication (requires historical data)
if previous_submissions:
    key_fields = ['reporting_jurisdiction', 'condition', 'birth_date', 'sex']
    current_keys = df[key_fields].apply(tuple, axis=1)
    previous_keys = previous_df[key_fields].apply(tuple, axis=1)

    cross_dups = current_keys.isin(previous_keys)
    if cross_dups.any():
        result.add_warning(
            f"Possible re-submission: {cross_dups.sum()} cases match previous submission",
            doc_link='#nnad-uniqueness-6-3'
        )
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Mumps System Content -->
<div id="mumps-content" class="system-content">
    <h3 style="color: #1e3a5f; margin: 2rem 0 1rem;">Mumps Disease Surveillance (MMG v1.0.2)</h3>
    <p style="color: #666; margin-bottom: 2rem;">
        Mumps-specific validations with clinical criteria (parotitis) and laboratory confirmation (IgM, PCR).
    </p>

    <!-- Completeness -->
    <div class="accordion">
        <div class="accordion-header" onclick="toggleAccordion(this)">
            <div class="accordion-title">
                <span class="accordion-icon">‚úì</span>
                <span>1. COMPLETENESS - Mumps Required Fields</span>
            </div>
            <span class="accordion-toggle">‚ñº</span>
        </div>
        <div class="accordion-content">
            <div class="accordion-body">
                <div class="rule-grid">
                    <div class="rule-card error" id="mumps-completeness-1-1">
                        <div class="rule-header">
                            <span class="rule-title">1.1 Core Mumps Fields</span>
                            <span class="severity-badge severity-error">ERROR</span>
                        </div>
                        <div class="rule-description">
                            Required: patient_id, reporting_jurisdiction, case_status, report_date, parotitis,
                            lab_result, specimen_collection_date.
                        </div>
                        <div class="rule-examples">
                            <div class="example-label">‚úì Valid:</div>
                            <div class="example-good">All required columns present in CSV</div>
                            <div class="example-label">‚úó Invalid:</div>
                            <div class="example-bad">Missing lab_result or parotitis column</div>
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
REQUIRED_FIELDS = [
    'condition', 'reporting_jurisdiction', 'case_status',
    'report_date', 'illness_onset_date', 'parotitis', 'lab_result'
]

missing = [col for col in REQUIRED_FIELDS if col not in df.columns]

if missing:
    result.add_error(
        f"Missing required mumps fields: {', '.join(missing)}",
        doc_link='#mumps-completeness-1-1'
    )
                        </div>
                    </div>

                    <div class="rule-card warning" id="mumps-completeness-1-2">
                        <div class="rule-header">
                            <span class="rule-title">1.2 Clinical Completeness</span>
                            <span class="severity-badge severity-warning">WARNING</span>
                        </div>
                        <div class="rule-description">
                            If parotitis=Y, expect parotitis_duration. If complications reported, expect hospitalization status.
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
if parotitis == 'Y' and (pd.isna(duration) or duration == 0):
    result.add_warning(
        "Parotitis is Yes but duration is missing/zero",
        row=idx+2,
        field='parotitis_duration_days',
        doc_link='#mumps-completeness-1-2'
    )

if pd.isna(parotitis):
    result.add_warning(
        "Parotitis value is missing",
        row=idx+2,
        field='parotitis',
        doc_link='#mumps-completeness-1-2'
    )
                        </div>
                    </div>

                    <div class="rule-card warning" id="mumps-completeness-1-3">
                        <div class="rule-header">
                            <span class="rule-title">1.3 Outbreak Name Required</span>
                            <span class="severity-badge severity-warning">WARNING</span>
                        </div>
                        <div class="rule-description">
                            If outbreak_associated=Y, outbreak_name should identify the specific outbreak investigation.
                            Essential for linking cases in MVPS.
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
if outbreak_str == 'Y' and 'outbreak_name' in df.columns:
    name = df['outbreak_name'].iloc[idx]
    if pd.isna(name) or not str(name).strip():
        result.add_warning(
            "Outbreak-associated but outbreak_name missing",
            row=idx+2,
            field='outbreak_name',
            doc_link='#mumps-completeness-1-3'
        )
                        </div>
                    </div>

                    <div class="rule-card warning" id="mumps-completeness-1-4">
                        <div class="rule-header">
                            <span class="rule-title">1.4 Travel History for Imported Cases</span>
                            <span class="severity-badge severity-warning">WARNING</span>
                        </div>
                        <div class="rule-description">
                            If import_status=Imported, travel_history should document country/region of acquisition.
                            Critical for tracking international mumps transmission.
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
if status_str in ['IMP', 'IMPORTED'] and 'travel_history' in df.columns:
    travel = df['travel_history'].iloc[idx]
    if pd.isna(travel) or not str(travel).strip():
        result.add_warning(
            "Import status=Imported but travel_history missing",
            row=idx+2,
            field='travel_history',
            doc_link='#mumps-completeness-1-4'
        )
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Accuracy -->
    <div class="accordion">
        <div class="accordion-header" onclick="toggleAccordion(this)">
            <div class="accordion-title">
                <span class="accordion-icon">üéØ</span>
                <span>2. ACCURACY - Clinical Data Plausibility</span>
            </div>
            <span class="accordion-toggle">‚ñº</span>
        </div>
        <div class="accordion-content">
            <div class="accordion-body">
                <div class="rule-grid">
                    <div class="rule-card error" id="mumps-accuracy-2-1">
                        <div class="rule-header">
                            <span class="rule-title">2.1 Parotitis Duration Plausibility</span>
                            <span class="severity-badge severity-error">ERROR</span>
                        </div>
                        <div class="rule-description">
                            Parotitis duration >60 days is implausible. Typical mumps parotitis lasts 7-10 days.
                            Values >60 likely indicate data entry errors (100 instead of 10).
                        </div>
                        <div class="rule-examples">
                            <div class="example-label">‚úì Plausible:</div>
                            <div class="example-good">parotitis_duration_days: 7</div>
                            <div class="example-label">‚úó Implausible:</div>
                            <div class="example-bad">parotitis_duration_days: 100 (likely typo for 10)</div>
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
if duration_val > 60:
    result.add_error(
        f"Parotitis duration {duration_val} days is implausible",
        field='parotitis_duration_days',
        doc_link='#mumps-accuracy-2-1'
    )
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Validity -->
    <div class="accordion">
        <div class="accordion-header" onclick="toggleAccordion(this)">
            <div class="accordion-title">
                <span class="accordion-icon">‚úîÔ∏è</span>
                <span>4. VALIDITY - Laboratory Codes</span>
            </div>
            <span class="accordion-toggle">‚ñº</span>
        </div>
        <div class="accordion-content">
            <div class="accordion-body">
                <div class="rule-grid">
                    <div class="rule-card error" id="mumps-validity-4-1">
                        <div class="rule-header">
                            <span class="rule-title">4.1 Lab Result SNOMED CT Codes</span>
                            <span class="severity-badge severity-error">ERROR</span>
                        </div>
                        <div class="rule-description">
                            Laboratory results must use approved SNOMED CT codes for mumps IgM/PCR testing.
                        </div>
                        <div class="rule-examples">
                            <div class="example-label">‚úì Valid codes:</div>
                            <div class="example-good">
                                10828004 (Positive) | 260385009 (Negative) |
                                260373001 (Detected) | 419984006 (Inconclusive)
                            </div>
                            <div class="example-label">‚úó Invalid:</div>
                            <div class="example-bad">"positive" | "neg" | 1 | blank</div>
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
LAB_RESULT_CODES = {
    '10828004': 'Positive',
    '260385009': 'Negative',
    '260373001': 'Detected',
    '260415000': 'Not Detected',
    '419984006': 'Inconclusive',
    '125154007': 'Specimen Unsatisfactory'
}

lab_result_str = str(lab_result).strip()
if lab_result_str not in LAB_RESULT_CODES:
    result.add_error(
        "Invalid lab result code",
        field='lab_result',
        doc_link='#mumps-validity-4-1'
    )
                        </div>
                    </div>

                    <div class="rule-card warning" id="mumps-validity-4-2">
                        <div class="rule-header">
                            <span class="rule-title">4.2 Parotitis Y/N/U Format</span>
                            <span class="severity-badge severity-warning">WARNING</span>
                        </div>
                        <div class="rule-description">
                            Parotitis field must be Y (Yes), N (No), or U (Unknown).
                            Free text like "yes", "true", "1" are flagged.
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
YNU_VALUES = {'Y': 'Yes', 'N': 'No', 'U': 'Unknown'}

is_valid, msg = validate_code_in_list(
    str(parotitis).upper(),
    YNU_VALUES.keys(),
    "Parotitis"
)
if not is_valid:
    result.add_error(
        msg,
        row=idx+2,
        field='parotitis',
        doc_link='#mumps-validity-4-2'
    )
                        </div>
                    </div>

                    <div class="rule-card warning" id="mumps-validity-4-3">
                        <div class="rule-header">
                            <span class="rule-title">4.3 Genotype Validation</span>
                            <span class="severity-badge severity-warning">WARNING</span>
                        </div>
                        <div class="rule-description">
                            Mumps genotype must be A-L, N, or UNK. Genotype should only be provided for PCR-positive cases.
                            Common circulating genotypes: G (US), H (UK), D (Asia).
                        </div>
                        <div class="rule-examples">
                            <div class="example-label">‚úì Valid:</div>
                            <div class="example-good">genotype=G, lab_result=10828004 (Positive)</div>
                            <div class="example-label">‚ö†Ô∏è Inconsistent:</div>
                            <div class="example-bad">genotype=G, lab_result=260385009 (Negative)</div>
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
MUMPS_GENOTYPES = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'N', 'UNK']

genotype_str = str(genotype).strip().upper()

if genotype_str and genotype_str not in MUMPS_GENOTYPES:
    result.add_warning(
        f"Non-standard genotype: {genotype} (expected: A-L, N, or UNK)",
        row=idx+2,
        field='genotype',
        doc_link='#mumps-validity-4-3'
    )
                        </div>
                    </div>

                    <div class="rule-card error" id="mumps-validity-4-4">
                        <div class="rule-header">
                            <span class="rule-title">4.4 Outbreak Associated Code</span>
                            <span class="severity-badge severity-error">ERROR</span>
                        </div>
                        <div class="rule-description">
                            Outbreak_associated must be Y/N/U. Free text values cause MVPS processing errors.
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
YNU_CODES = {'Y': 'Yes', 'N': 'No', 'U': 'Unknown'}

if outbreak_str not in YNU_CODES.keys():
    result.add_error(
        f"Invalid outbreak_associated: {outbreak} (must be Y/N/U)",
        row=idx+2,
        field='outbreak_associated',
        doc_link='#mumps-validity-4-4'
    )
                        </div>
                    </div>

                    <div class="rule-card warning" id="mumps-validity-4-5">
                        <div class="rule-header">
                            <span class="rule-title">4.5 Import Status Codes</span>
                            <span class="severity-badge severity-warning">WARNING</span>
                        </div>
                        <div class="rule-description">
                            Recommend standard codes: IMP (Imported), IND (Import-related), INC (Indigenous), UNK (Unknown).
                            Standardizes tracking of international vs domestic mumps transmission.
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
valid_import = ['IMP', 'IND', 'INC', 'UNK', 'IMPORTED', 'INDIGENOUS', 'IMPORT-RELATED', 'UNKNOWN']

if status_str not in valid_import:
    result.add_warning(
        f"Non-standard import status: {status} (recommend: IMP/IND/INC/UNK)",
        row=idx+2,
        field='import_status',
        doc_link='#mumps-validity-4-5'
    )
                        </div>
                    </div>

                    <div class="rule-card error" id="mumps-validity-4-6">
                        <div class="rule-header">
                            <span class="rule-title">4.6 Date Format (ISO 8601)</span>
                            <span class="severity-badge severity-error">ERROR</span>
                        </div>
                        <div class="rule-description">
                            All dates must follow YYYY-MM-DD format (ISO 8601).
                            Prevents MVPS processing errors from inconsistent date formats.
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
date_fields = ['report_date', 'illness_onset_date',
               'specimen_collection_date', 'lab_result_date']

for field in date_fields:
    if field in df.columns and pd.notna(date_val):
        is_valid, msg = validate_date_format(date_val)
        if not is_valid:
            result.add_error(
                f"{field}: {msg}",
                row=idx+2,
                field=field,
                doc_link='#mumps-validity-4-6'
            )
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Timeliness -->
    <div class="accordion">
        <div class="accordion-header" onclick="toggleAccordion(this)">
            <div class="accordion-title">
                <span class="accordion-icon">‚è±Ô∏è</span>
                <span>5. TIMELINESS - Specimen Collection Timing</span>
            </div>
            <span class="accordion-toggle">‚ñº</span>
        </div>
        <div class="accordion-content">
            <div class="accordion-body">
                <div class="rule-grid">
                    <div class="rule-card warning" id="mumps-timeliness-5-1">
                        <div class="rule-header">
                            <span class="rule-title">5.1 IgM Specimen Collection Window</span>
                            <span class="severity-badge severity-warning">WARNING</span>
                        </div>
                        <div class="rule-description">
                            Mumps IgM testing is most accurate 3-45 days after illness onset.
                            Specimens collected too early (<3 days) or too late (>45 days) may yield false negatives.
                            Affects case classification accuracy.
                        </div>
                        <div class="rule-examples">
                            <div class="example-label">‚úì Optimal:</div>
                            <div class="example-good">Onset: 2026-01-01 ‚Üí IgM specimen: 2026-01-08 (7 days)</div>
                            <div class="example-label">‚ö†Ô∏è Suboptimal:</div>
                            <div class="example-bad">Onset: 2026-01-01 ‚Üí IgM specimen: 2025-12-30 (before onset - false negative risk)</div>
                            <div class="example-bad">Onset: 2026-01-01 ‚Üí IgM specimen: 2026-03-01 (60 days - false negative risk)</div>
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
days_from_onset = (collection_dt - onset_dt).days

if days_from_onset < 3:
    result.add_warning(
        f"IgM specimen collected {days_from_onset} days after onset (optimal: 3-45 days)",
        field='specimen_collection_date',
        doc_link='#mumps-timeliness-5-1'
    )
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Consistency -->
    <div class="accordion">
        <div class="accordion-header" onclick="toggleAccordion(this)">
            <div class="accordion-title">
                <span class="accordion-icon">üîó</span>
                <span>3. CONSISTENCY - Clinical-Lab Agreement</span>
            </div>
            <span class="accordion-toggle">‚ñº</span>
        </div>
        <div class="accordion-content">
            <div class="accordion-body">
                <div class="rule-grid">
                    <div class="rule-card warning" id="mumps-consistency-3-1">
                        <div class="rule-header">
                            <span class="rule-title">3.1 Parotitis-Lab Correlation</span>
                            <span class="severity-badge severity-warning">WARNING</span>
                        </div>
                        <div class="rule-description">
                            If parotitis=N but lab=Positive, case classification may be questionable.
                            If parotitis=Y but lab=Negative, may be clinical mumps or false negative.
                        </div>
                        <div class="rule-examples">
                            <div class="example-label">‚úì Consistent:</div>
                            <div class="example-good">parotitis=Y, lab=Positive (Confirmed case)</div>
                            <div class="example-label">‚ö†Ô∏è Review:</div>
                            <div class="example-bad">parotitis=N, lab=Positive (asymptomatic?)</div>
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
parotitis = str(df['parotitis'].iloc[idx]).upper()

# Confirmed case should have positive lab result
if status == '410605003' and lab != '10828004':
    result.add_warning(
        "Case is Confirmed but lab result is not Positive",
        row=idx+2,
        field='case_status',
        doc_link='#mumps-consistency-3-1'
    )

# Parotitis = No but lab positive
if parotitis == 'N' and pd.notna(duration) and duration > 0:
    result.add_warning(
        "Parotitis is No but duration > 0",
        row=idx+2,
        field='parotitis_duration_days',
        doc_link='#mumps-consistency-3-1'
    )
                        </div>
                    </div>

                    <div class="rule-card error" id="mumps-consistency-3-2">
                        <div class="rule-header">
                            <span class="rule-title">3.2 Specimen Date Before Result</span>
                            <span class="severity-badge severity-error">ERROR</span>
                        </div>
                        <div class="rule-description">
                            Specimen collection date must be before or same as lab result date.
                            Cannot get results before collecting specimen.
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
collection_dt = pd.to_datetime(collection)
result_dt = pd.to_datetime(result_date)

if collection_dt > result_dt:
    result.add_error(
        "Specimen collection date after result date",
        row=idx+2,
        field='specimen_collection_date',
        doc_link='#mumps-consistency-3-2'
    )
                        </div>
                    </div>

                    <div class="rule-card warning" id="mumps-consistency-3-3">
                        <div class="rule-header">
                            <span class="rule-title">3.3 Clinical Case Definition Criteria</span>
                            <span class="severity-badge severity-warning">WARNING</span>
                        </div>
                        <div class="rule-description">
                            Per CSTE case definition, clinical mumps requires parotitis ‚â•2 days duration.
                            Cases with parotitis <2 days may not meet case criteria.
                        </div>
                        <div class="rule-examples">
                            <div class="example-label">‚úì Meets criteria:</div>
                            <div class="example-good">parotitis=Y, duration=7 days</div>
                            <div class="example-label">‚ö†Ô∏è Does not meet:</div>
                            <div class="example-bad">parotitis=Y, duration=1 day (insufficient for case definition)</div>
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
if 'parotitis' in df.columns:
    parotitis = str(df['parotitis'].iloc[idx]).upper()
    duration_val = int(duration)

    if parotitis == 'Y' and duration_val < 2:
        result.add_warning(
            f"Parotitis duration {duration_val} day(s) does not meet clinical case definition (‚â•2 days)",
            row=idx+2,
            field='parotitis_duration_days',
            doc_link='#mumps-consistency-3-3'
        )
                        </div>
                    </div>

                    <div class="rule-card error" id="mumps-consistency-3-4">
                        <div class="rule-header">
                            <span class="rule-title">3.4 Sex-Specific Complications</span>
                            <span class="severity-badge severity-error">ERROR</span>
                        </div>
                        <div class="rule-description">
                            Orchitis (testicular inflammation) only occurs in males.
                            Oophoritis (ovarian inflammation) only occurs in females.
                            Common data entry error when copying/pasting records.
                        </div>
                        <div class="rule-examples">
                            <div class="example-label">‚úó Invalid:</div>
                            <div class="example-bad">sex=F, orchitis=Y (anatomically impossible)</div>
                            <div class="example-bad">sex=M, oophoritis=Y (anatomically impossible)</div>
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
if orchitis == 'Y' and sex == 'F':
    result.add_error(
        "Orchitis cannot occur in female patients",
        field='orchitis',
        doc_link='#mumps-consistency-3-4'
    )
                        </div>
                    </div>

                    <div class="rule-card warning" id="mumps-consistency-3-5">
                        <div class="rule-header">
                            <span class="rule-title">3.5 Severe Complications vs Hospitalization</span>
                            <span class="severity-badge severity-warning">WARNING</span>
                        </div>
                        <div class="rule-description">
                            Severe complications (encephalitis, meningitis, pancreatitis) typically require hospitalization.
                            Cases with severe complications but hospitalized=N are flagged for verification.
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
severe_comps = []
if 'encephalitis' in df.columns and str(df['encephalitis'].iloc[idx]).upper() == 'Y':
    severe_comps.append('encephalitis')
if 'meningitis' in df.columns and str(df['meningitis'].iloc[idx]).upper() == 'Y':
    severe_comps.append('meningitis')
if 'pancreatitis' in df.columns and str(df['pancreatitis'].iloc[idx]).upper() == 'Y':
    severe_comps.append('pancreatitis')

if severe_comps and hospitalized == 'N':
    result.add_warning(
        f"Severe complications ({', '.join(severe_comps)}) but not hospitalized",
        row=idx+2,
        field='hospitalized',
        doc_link='#mumps-consistency-3-5'
    )
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- NREVSS System Content -->
<div id="nrevss-content" class="system-content">
    <h3 style="color: #1e3a5f; margin: 2rem 0 1rem;">NREVSS (Laboratory Surveillance)</h3>
    <p style="color: #666; margin-bottom: 2rem;">
        Laboratory-based surveillance for respiratory viruses. Weekly aggregate reports from participating labs.
    </p>

    <!-- Completeness -->
    <div class="accordion">
        <div class="accordion-header" onclick="toggleAccordion(this)">
            <div class="accordion-title">
                <span class="accordion-icon">‚úì</span>
                <span>1. COMPLETENESS - Laboratory Report Fields</span>
            </div>
            <span class="accordion-toggle">‚ñº</span>
        </div>
        <div class="accordion-content">
            <div class="accordion-body">
                <div class="rule-grid">
                    <div class="rule-card error" id="nrevss-completeness-1-1">
                        <div class="rule-header">
                            <span class="rule-title">1.1 Required Laboratory Fields</span>
                            <span class="severity-badge severity-error">ERROR</span>
                        </div>
                        <div class="rule-description">
                            Required: reporting_week, reporting_lab, state, total_specimens_tested, virus_type.
                            Weekly lab reports must include all core fields.
                        </div>
                        <div class="rule-examples">
                            <div class="example-label">‚úì Valid:</div>
                            <div class="example-good">All required columns present in weekly report CSV</div>
                            <div class="example-label">‚úó Invalid:</div>
                            <div class="example-bad">Missing virus_type or reporting_week column</div>
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
REQUIRED_FIELDS = [
    'reporting_week', 'reporting_lab', 'state',
    'total_specimens_tested', 'virus_type'
]

missing = [col for col in REQUIRED_FIELDS if col not in df.columns]

if missing:
    result.add_error(
        f"Missing required NREVSS fields: {', '.join(missing)}",
        doc_link='#nrevss-completeness-1-1'
    )
                        </div>
                    </div>

                    <div class="rule-card error" id="nrevss-completeness-1-2">
                        <div class="rule-header">
                            <span class="rule-title">1.2 Result Fields Required</span>
                            <span class="severity-badge severity-error">ERROR</span>
                        </div>
                        <div class="rule-description">
                            At least one result field required: positive_results, negative_results, or percent_positive.
                            Cannot submit report without test results.
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
VIRUS_RESULT_FIELDS = [
    'positive_results', 'negative_results', 'percent_positive'
]

result_present = [col for col in VIRUS_RESULT_FIELDS if col in df.columns]

if len(result_present) == 0:
    result.add_error(
        "No virus result fields found",
        doc_link='#nrevss-completeness-1-2'
    )
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Additional Completeness Rules -->
    <div class="accordion">
        <div class="accordion-header" onclick="toggleAccordion(this)">
            <div class="accordion-title">
                <span class="accordion-icon">‚úì</span>
                <span>1. COMPLETENESS (Continued)</span>
            </div>
            <span class="accordion-toggle">‚ñº</span>
        </div>
        <div class="accordion-content">
            <div class="accordion-body">
                <div class="rule-grid">
                    <div class="rule-card error" id="nrevss-completeness-1-1">
                        <div class="rule-header">
                            <span class="rule-title">1.1 Reporting Week Cannot Be Blank</span>
                            <span class="severity-badge severity-error">ERROR</span>
                        </div>
                        <div class="rule-description">
                            Reporting week is required for all laboratory reports.
                            Links surveillance data to CDC MMWR week for temporal analysis.
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
if 'reporting_week' in df.columns:
    if pd.isna(week):
        result.add_error(
            "Reporting week is missing",
            row=idx+2,
            field='reporting_week',
            doc_link='#nrevss-completeness-1-1'
        )
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Validity -->
    <div class="accordion">
        <div class="accordion-header" onclick="toggleAccordion(this)">
            <div class="accordion-title">
                <span class="accordion-icon">‚úîÔ∏è</span>
                <span>4. VALIDITY - CDC Week Format & Codes</span>
            </div>
            <span class="accordion-toggle">‚ñº</span>
        </div>
        <div class="accordion-content">
            <div class="accordion-body">
                <div class="rule-grid">
                    <div class="rule-card error" id="nrevss-validity-4-1">
                        <div class="rule-header">
                            <span class="rule-title">4.1 CDC Week Format (YYYY-WNN)</span>
                            <span class="severity-badge severity-error">ERROR</span>
                        </div>
                        <div class="rule-description">
                            Reporting week must follow CDC's Morbidity and Mortality Weekly Report (MMWR) format: YYYY-WNN.
                            Four-digit year, hyphen, letter W, two-digit week (01-53).
                        </div>
                        <div class="rule-examples">
                            <div class="example-label">‚úì Valid:</div>
                            <div class="example-good">2026-W04 | 2025-W52 | 2026-W01</div>
                            <div class="example-label">‚úó Invalid:</div>
                            <div class="example-bad">2026-04 | W04-2026 | 2026/W04 | Week 4</div>
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
import re

week_str = str(week).strip()
# Check format: YYYY-WNN
if not re.match(r'^\d{4}-W\d{2}$', week_str):
    result.add_error(
        f"Invalid week format: {week_str} (expected YYYY-WNN)",
        field='reporting_week',
        doc_link='#nrevss-validity-4-1'
    )
                        </div>
                    </div>

                    <div class="rule-card warning" id="nrevss-validity-4-2">
                        <div class="rule-header">
                            <span class="rule-title">4.2 Recognized Virus Types</span>
                            <span class="severity-badge severity-warning">WARNING</span>
                        </div>
                        <div class="rule-description">
                            Virus type should match standard NREVSS categories: RSV, Influenza A/B, Parainfluenza 1-4,
                            Adenovirus, Rhinovirus, Enterovirus, Human Metapneumovirus, Coronavirus, SARS-CoV-2.
                        </div>
                        <div class="rule-examples">
                            <div class="example-label">‚úì Valid:</div>
                            <div class="example-good">RSV | Influenza A | Parainfluenza 1 | SARS-CoV-2</div>
                            <div class="example-label">‚ö†Ô∏è Unexpected:</div>
                            <div class="example-bad">Flu | COVID | Para-1 (use standard names)</div>
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
VIRUS_TYPES = [
    'RSV', 'Influenza A', 'Influenza B',
    'Parainfluenza 1', 'Parainfluenza 2', 'Parainfluenza 3', 'Parainfluenza 4',
    'Adenovirus', 'Rhinovirus', 'Enterovirus',
    'Human Metapneumovirus', 'Coronavirus (non-COVID)', 'SARS-CoV-2'
]

if virus not in VIRUS_TYPES:
    result.add_warning(
        f"Unexpected virus type: {virus}",
        row=idx+2,
        field='virus_type',
        doc_link='#nrevss-validity-4-2'
    )
                        </div>
                    </div>

                    <div class="rule-card error" id="nrevss-validity-4-3">
                        <div class="rule-header">
                            <span class="rule-title">4.3 State Code Validation</span>
                            <span class="severity-badge severity-error">ERROR</span>
                        </div>
                        <div class="rule-description">
                            State must be valid 2-letter US state/territory abbreviation (50 states + DC, PR, VI, GU, AS, MP).
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
if 'state' in df.columns:
    state_info = validate_state_code(state, 'abbr')
    if not state_info:
        result.add_error(
            f"Invalid state code: {state}",
            row=idx+2,
            field='state',
            doc_link='#nrevss-validity-4-3'
        )
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Accuracy -->
    <div class="accordion">
        <div class="accordion-header" onclick="toggleAccordion(this)">
            <div class="accordion-title">
                <span class="accordion-icon">üéØ</span>
                <span>2. ACCURACY - Specimen Count Ranges</span>
            </div>
            <span class="accordion-toggle">‚ñº</span>
        </div>
        <div class="accordion-content">
            <div class="accordion-body">
                <div class="rule-grid">
                    <div class="rule-card error" id="nrevss-accuracy-2-1">
                        <div class="rule-header">
                            <span class="rule-title">2.1 Specimen Count Range</span>
                            <span class="severity-badge severity-error">ERROR</span>
                        </div>
                        <div class="rule-description">
                            Total specimens tested must be 0-100,000 per week per lab.
                            Values above 100,000 likely indicate data entry errors (extra zeros).
                        </div>
                        <div class="rule-examples">
                            <div class="example-label">‚úì Valid:</div>
                            <div class="example-good">total_specimens_tested: 523</div>
                            <div class="example-label">‚úó Invalid:</div>
                            <div class="example-bad">total_specimens_tested: 5230000 (likely typo)</div>
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
if 'total_specimens_tested' in df.columns:
    is_valid, msg = validate_integer(total, min_val=0, max_val=100000)
    if not is_valid:
        result.add_error(
            f"Total specimens: {msg}",
            row=idx+2,
            field='total_specimens_tested',
            doc_link='#nrevss-accuracy-2-1'
        )
                        </div>
                    </div>

                    <div class="rule-card warning" id="nrevss-accuracy-2-2">
                        <div class="rule-header">
                            <span class="rule-title">2.2 Low Specimen Count Warning</span>
                            <span class="severity-badge severity-warning">WARNING</span>
                        </div>
                        <div class="rule-description">
                            Less than 10 specimens tested is unusually low for weekly aggregate reporting.
                            May indicate incomplete data or partial week reporting. Verify with lab.
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
if 'total_specimens_tested' in df.columns:
    total_val = int(total)
    if total_val < 10:
        result.add_warning(
            f"Very low specimen count ({total_val}) - verify data",
            row=idx+2,
            field='total_specimens_tested',
            doc_link='#nrevss-accuracy-2-2'
        )
                        </div>
                    </div>

                    <div class="rule-card error" id="nrevss-accuracy-2-3">
                        <div class="rule-header">
                            <span class="rule-title">2.3 Result Count Validation</span>
                            <span class="severity-badge severity-error">ERROR</span>
                        </div>
                        <div class="rule-description">
                            Positive and negative result counts must be non-negative integers.
                            Percent positive must be 0-100%. Invalid values cause MVPS processing errors.
                        </div>
                        <div class="rule-examples">
                            <div class="example-label">‚úó Invalid:</div>
                            <div class="example-bad">positive_results: -5 (cannot be negative)</div>
                            <div class="example-bad">percent_positive: 150 (exceeds 100%)</div>
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
# Positive results validation
is_valid, msg = validate_integer(positive, min_val=0)
if not is_valid:
    result.add_error(
        f"Positive results: {msg}",
        row=idx+2,
        field='positive_results',
        doc_link='#nrevss-accuracy-2-3'
    )

# Percent positive validation
is_valid, msg = validate_percentage(pct)
if not is_valid:
    result.add_error(
        f"Percent positive: {msg}",
        row=idx+2,
        field='percent_positive',
        doc_link='#nrevss-accuracy-2-3'
    )
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Consistency -->
    <div class="accordion">
        <div class="accordion-header" onclick="toggleAccordion(this)">
            <div class="accordion-title">
                <span class="accordion-icon">üîó</span>
                <span>3. CONSISTENCY - Result Calculations</span>
            </div>
            <span class="accordion-toggle">‚ñº</span>
        </div>
        <div class="accordion-content">
            <div class="accordion-body">
                <div class="rule-grid">
                    <div class="rule-card error" id="nrevss-consistency-3-1">
                        <div class="rule-header">
                            <span class="rule-title">3.1 Positive + Negative = Total</span>
                            <span class="severity-badge severity-error">ERROR</span>
                        </div>
                        <div class="rule-description">
                            The sum of positive_results and negative_results must equal total_specimens_tested.
                            This is a fundamental consistency check for laboratory data.
                        </div>
                        <div class="rule-examples">
                            <div class="example-label">‚úì Valid:</div>
                            <div class="example-good">Positive: 45, Negative: 478, Total: 523 (45+478=523)</div>
                            <div class="example-label">‚úó Invalid:</div>
                            <div class="example-bad">Positive: 45, Negative: 478, Total: 500 (45+478‚â†500)</div>
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
if pos_val + neg_val != total_val:
    result.add_error(
        f"Positive ({pos_val}) + Negative ({neg_val}) ‚â† Total ({total_val})",
        field='total_specimens_tested',
        doc_link='#nrevss-consistency-3-1'
    )
                        </div>
                    </div>

                    <div class="rule-card warning" id="nrevss-consistency-3-2">
                        <div class="rule-header">
                            <span class="rule-title">3.2 Percent Positive Calculation</span>
                            <span class="severity-badge severity-warning">WARNING</span>
                        </div>
                        <div class="rule-description">
                            Calculated percent positive (positive/total √ó 100) should match reported percent_positive field.
                            Allows ¬±0.2% difference for rounding. Larger discrepancies indicate calculation errors.
                        </div>
                        <div class="rule-examples">
                            <div class="example-label">‚úì Consistent:</div>
                            <div class="example-good">45/523 √ó 100 = 8.6%, reported: 8.6%</div>
                            <div class="example-label">‚ö†Ô∏è Mismatch:</div>
                            <div class="example-bad">45/523 √ó 100 = 8.6%, reported: 12.5%</div>
                        </div>
                        <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                        <div class="code-block">
if total_val > 0:
    calculated_pct = round((pos_val / total_val) * 100, 1)

    # Allow small rounding differences
    if abs(calculated_pct - reported_pct_val) > 0.2:
        result.add_warning(
            f"Percent positive mismatch: Reported {reported_pct_val}%, Calculated {calculated_pct}%",
            row=idx+2,
            field='percent_positive',
            doc_link='#nrevss-consistency-3-2'
        )
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div style="text-align: center; margin: 3rem 0;">
    <a href="/" class="btn btn-secondary">Back to Dashboard</a>
</div>

<script>
// Toggle accordion
function toggleAccordion(header) {
    const content = header.nextElementSibling;
    const toggle = header.querySelector('.accordion-toggle');

    header.classList.toggle('active');
    content.classList.toggle('show');
    toggle.classList.toggle('active');
}

// Toggle code blocks
function toggleCode(button) {
    const codeBlock = button.nextElementSibling;
    codeBlock.classList.toggle('show');
    button.textContent = codeBlock.classList.contains('show') ? 'Hide Code' : 'Show Code';
}

// Switch between systems
function showSystem(systemId) {
    // Update tabs
    document.querySelectorAll('.system-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    event.target.classList.add('active');

    // Update content
    document.querySelectorAll('.system-content').forEach(content => {
        content.classList.remove('active');
    });
    document.getElementById(systemId + '-content').classList.add('active');
}

// Scroll to dimension
function scrollToDimension(dimensionId) {
    const element = document.getElementById(dimensionId);
    if (element) {
        element.scrollIntoView({ behavior: 'smooth', block: 'start' });

        // Open the accordion if closed
        const header = element.querySelector('.accordion-header');
        if (header && !header.classList.contains('active')) {
            toggleAccordion(header);
        }
    }
}

// Search/filter function
function filterContent() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const ruleCards = document.querySelectorAll('.rule-card');

    ruleCards.forEach(card => {
        const text = card.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
            card.style.display = 'block';
            card.style.animation = 'slideDown 0.3s ease-out';
        } else {
            card.style.display = 'none';
        }
    });

    // If searching, open all accordions
    if (searchTerm.length > 2) {
        document.querySelectorAll('.accordion-header:not(.active)').forEach(header => {
            toggleAccordion(header);
        });
    }
}

// Handle deep links from error messages
function handleDeepLink() {
    const hash = window.location.hash;
    if (hash) {
        // Extract system from hash (e.g., #nnad-completeness-1-1 -> nnad)
        const system = hash.substring(1).split('-')[0];

        // Switch to correct system tab
        if (system === 'nnad' || system === 'mumps' || system === 'nrevss') {
            document.querySelectorAll('.system-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.system-content').forEach(content => {
                content.classList.remove('active');
            });

            const systemTab = Array.from(document.querySelectorAll('.system-tab')).find(
                tab => tab.textContent.toLowerCase().includes(system)
            );
            if (systemTab) systemTab.classList.add('active');

            const systemContent = document.getElementById(system + '-content');
            if (systemContent) systemContent.classList.add('active');
        }

        // Find the target element
        const targetElement = document.querySelector(hash);
        if (targetElement) {
            // Find parent accordion and open it
            let parent = targetElement.parentElement;
            while (parent && !parent.classList.contains('accordion-content')) {
                parent = parent.parentElement;
            }

            if (parent && !parent.classList.contains('show')) {
                const header = parent.previousElementSibling;
                if (header && header.classList.contains('accordion-header')) {
                    toggleAccordion(header);
                }
            }

            // Scroll to element
            setTimeout(() => {
                targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });

                // Highlight the rule card
                targetElement.style.boxShadow = '0 0 0 4px #ffc107';
                targetElement.style.transition = 'box-shadow 0.3s ease';

                setTimeout(() => {
                    targetElement.style.boxShadow = '';
                }, 2000);
            }, 300);
        }
    }
}

// Run deep link handler on page load
document.addEventListener('DOMContentLoaded', handleDeepLink);
// Also run when hash changes (for navigation within page)
window.addEventListener('hashchange', handleDeepLink);
</script>
{% endblock %}
