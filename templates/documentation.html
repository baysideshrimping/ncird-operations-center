{% extends "base.html" %}

{% block title %}Validation Documentation - NCIRD{% endblock %}

{% block extra_css %}
<style>
    .doc-section {
        background: white;
        border-radius: 8px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .system-doc {
        margin-bottom: 3rem;
        border-left: 4px solid #2c5282;
        padding-left: 1.5rem;
    }

    .system-doc h2 {
        color: #1e3a5f;
        margin-bottom: 0.5rem;
    }

    .system-doc .description {
        color: #666;
        margin-bottom: 1.5rem;
        font-style: italic;
    }

    .validation-category {
        margin: 2rem 0;
    }

    .validation-category h3 {
        color: #2c5282;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #e9ecef;
    }

    .validation-rule {
        background: #f8f9fa;
        padding: 1.5rem;
        margin-bottom: 1rem;
        border-radius: 6px;
        border-left: 3px solid #28a745;
    }

    .validation-rule.warning {
        border-left-color: #ffc107;
    }

    .validation-rule.error {
        border-left-color: #dc3545;
    }

    .rule-title {
        font-weight: 600;
        color: #1e3a5f;
        margin-bottom: 0.5rem;
        font-size: 1.1rem;
    }

    .rule-description {
        color: #333;
        line-height: 1.6;
        margin-bottom: 1rem;
    }

    .rule-examples {
        background: white;
        padding: 1rem;
        border-radius: 4px;
        margin-top: 1rem;
    }

    .rule-examples h4 {
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 0.5rem;
    }

    .example-good {
        color: #28a745;
        font-family: 'Courier New', monospace;
        padding: 0.5rem;
        background: #d4edda;
        border-radius: 4px;
        margin: 0.5rem 0;
    }

    .example-bad {
        color: #dc3545;
        font-family: 'Courier New', monospace;
        padding: 0.5rem;
        background: #f8d7da;
        border-radius: 4px;
        margin: 0.5rem 0;
    }

    .code-toggle {
        background: #2c5282;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        margin-top: 0.5rem;
    }

    .code-toggle:hover {
        background: #1e3a5f;
    }

    .code-block {
        display: none;
        background: #282c34;
        color: #abb2bf;
        padding: 1rem;
        border-radius: 4px;
        margin-top: 1rem;
        overflow-x: auto;
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
    }

    .code-block.show {
        display: block;
    }

    .severity-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 600;
        margin-left: 0.5rem;
    }

    .severity-error {
        background: #dc3545;
        color: white;
    }

    .severity-warning {
        background: #ffc107;
        color: #333;
    }

    .severity-info {
        background: #17a2b8;
        color: white;
    }

    .toc {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 2rem;
    }

    .toc h3 {
        margin-bottom: 1rem;
        color: #1e3a5f;
    }

    .toc ul {
        list-style: none;
        padding-left: 1rem;
    }

    .toc li {
        margin: 0.5rem 0;
    }

    .toc a {
        color: #2c5282;
        text-decoration: none;
    }

    .toc a:hover {
        text-decoration: underline;
    }
</style>
{% endblock %}

{% block content %}
<h1 style="color: #1e3a5f; margin-bottom: 1rem;">Validation Documentation</h1>
<p style="color: #666; margin-bottom: 2rem;">
    Comprehensive guide to all data validation rules applied across NCIRD data streams.
    Click "Show Code" to see the actual validation implementation.
</p>

<!-- Table of Contents -->
<div class="toc">
    <h3>Quick Navigation</h3>
    <ul>
        <li><a href="#nnad">NNAD (National Notifiable Diseases)</a></li>
        <li><a href="#mumps">Mumps Disease Surveillance</a></li>
        <li><a href="#nrevss">NREVSS (Laboratory Surveillance)</a></li>
    </ul>
</div>

<!-- NNAD Documentation -->
<div class="doc-section">
    <div class="system-doc" id="nnad">
        <h2>NNAD (National Notifiable Diseases Surveillance System)</h2>
        <p class="description">
            Case-based surveillance for 120+ nationally notifiable diseases using Generic v2 MMG standards
        </p>

        <div class="validation-category">
            <h3>1. File Structure Validation</h3>

            <div class="validation-rule error">
                <div class="rule-title">
                    Required Fields Must Be Present
                    <span class="severity-badge severity-error">ERROR</span>
                </div>
                <div class="rule-description">
                    All NNAD submissions must include these mandatory fields: condition, reporting_jurisdiction,
                    case_status, report_date, and illness_onset_date. Missing any of these will cause validation to fail.
                </div>
                <div class="rule-examples">
                    <h4>✓ Valid:</h4>
                    <div class="example-good">condition,reporting_jurisdiction,case_status,report_date,illness_onset_date,...</div>
                    <h4>✗ Invalid:</h4>
                    <div class="example-bad">condition,reporting_jurisdiction,case_status (missing report_date)</div>
                </div>
                <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                <div class="code-block">
REQUIRED_FIELDS = [
    'condition',
    'reporting_jurisdiction',
    'case_status',
    'report_date',
    'illness_onset_date'
]

missing = [col for col in REQUIRED_FIELDS if col not in df.columns]
if missing:
    result.add_error(f"Missing required fields: {', '.join(missing)}")
                </div>
            </div>
        </div>

        <div class="validation-category">
            <h3>2. Jurisdiction Validation</h3>

            <div class="validation-rule error">
                <div class="rule-title">
                    Valid State/Territory Codes
                    <span class="severity-badge severity-error">ERROR</span>
                </div>
                <div class="rule-description">
                    The reporting_jurisdiction must be a valid 2-letter US state or territory abbreviation.
                    Includes all 50 states plus DC, PR, GU, VI, AS, and MP.
                </div>
                <div class="rule-examples">
                    <h4>✓ Valid:</h4>
                    <div class="example-good">CA, NY, TX, FL, PR, GU</div>
                    <h4>✗ Invalid:</h4>
                    <div class="example-bad">ZZ, XX, California (must be 2-letter code)</div>
                </div>
                <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                <div class="code-block">
state_info = validate_state_code(jurisdiction, 'abbr')
if not state_info:
    result.add_error(
        f"Invalid jurisdiction code: {jurisdiction}",
        row=idx+2,
        field='reporting_jurisdiction'
    )
    # Suggest similar codes
    nearby = [s for s in VALID_STATE_ABBRS if s[0] == jurisdiction[0]]
    result.add_info(f"Did you mean: {', '.join(nearby)}?")
                </div>
            </div>
        </div>

        <div class="validation-category">
            <h3>3. Case Status Validation</h3>

            <div class="validation-rule error">
                <div class="rule-title">
                    Valid Case Classification Codes
                    <span class="severity-badge severity-error">ERROR</span>
                </div>
                <div class="rule-description">
                    Case status must use SNOMED CT codes: 410605003 (Confirmed), 2931005 (Probable),
                    415684004 (Suspected), or PHC1464 (Not a case).
                </div>
                <div class="rule-examples">
                    <h4>✓ Valid:</h4>
                    <div class="example-good">410605003 (Confirmed case)</div>
                    <h4>✗ Invalid:</h4>
                    <div class="example-bad">confirmed, CONFIRMED, 123456</div>
                </div>
                <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                <div class="code-block">
CASE_STATUS_CODES = {
    '410605003': 'Confirmed',
    '2931005': 'Probable',
    '415684004': 'Suspected',
    'PHC1464': 'Not a case'
}

status_str = str(status).strip()
if status_str not in CASE_STATUS_CODES:
    result.add_error("Invalid case status code")
                </div>
            </div>
        </div>

        <div class="validation-category">
            <h3>4. Date Validation</h3>

            <div class="validation-rule error">
                <div class="rule-title">
                    Date Format and Logic
                    <span class="severity-badge severity-error">ERROR</span>
                </div>
                <div class="rule-description">
                    All dates must be in YYYY-MM-DD format. Illness onset date cannot be after report date.
                </div>
                <div class="rule-examples">
                    <h4>✓ Valid:</h4>
                    <div class="example-good">2026-01-15 (onset) → 2026-01-20 (report)</div>
                    <h4>✗ Invalid:</h4>
                    <div class="example-bad">01/15/2026, 2026-01-20 (onset) → 2026-01-15 (report)</div>
                </div>
                <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                <div class="code-block">
# Date format validation
is_valid, msg = validate_date_format(date_val, '%Y-%m-%d')

# Date logic validation
onset_date = pd.to_datetime(onset)
report_date = pd.to_datetime(report)
if onset_date > report_date:
    result.add_error(
        "Illness onset date cannot be after report date"
    )
                </div>
            </div>
        </div>

        <div class="validation-category">
            <h3>5. Age Validation</h3>

            <div class="validation-rule warning">
                <div class="rule-title">
                    Age Range and Unit Validation
                    <span class="severity-badge severity-warning">WARNING</span>
                </div>
                <div class="rule-description">
                    Age must be 0-120 years. Age unit must be 'a' (years), 'mo' (months), 'd' (days), or 'h' (hours).
                </div>
                <div class="rule-examples">
                    <h4>✓ Valid:</h4>
                    <div class="example-good">25 (age) + 'a' (years)</div>
                    <h4>✗ Invalid:</h4>
                    <div class="example-bad">999 (age), 'years' (should be 'a')</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Mumps Documentation -->
<div class="doc-section">
    <div class="system-doc" id="mumps">
        <h2>Mumps Disease Surveillance (MMG v1.0.2)</h2>
        <p class="description">
            Mumps-specific case surveillance with clinical and laboratory validation
        </p>

        <div class="validation-category">
            <h3>1. Clinical Validation</h3>

            <div class="validation-rule error">
                <div class="rule-title">
                    Parotitis Presence Required
                    <span class="severity-badge severity-error">ERROR</span>
                </div>
                <div class="rule-description">
                    Parotitis (salivary gland swelling) is a key symptom and must be documented as Y (Yes),
                    N (No), or U (Unknown). Cannot be left blank.
                </div>
                <div class="rule-examples">
                    <h4>✓ Valid:</h4>
                    <div class="example-good">Y, N, U</div>
                    <h4>✗ Invalid:</h4>
                    <div class="example-bad">blank, yes, no, 1, 0</div>
                </div>
                <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                <div class="code-block">
YNU_VALUES = {'Y': 'Yes', 'N': 'No', 'U': 'Unknown'}

is_valid = str(parotitis).upper() in YNU_VALUES
if not is_valid:
    result.add_error(
        "Parotitis must be Y, N, or U",
        field='parotitis'
    )
                </div>
            </div>

            <div class="validation-rule warning">
                <div class="rule-title">
                    Parotitis Duration Logic
                    <span class="severity-badge severity-warning">WARNING</span>
                </div>
                <div class="rule-description">
                    If parotitis = Y, duration should be > 0. If parotitis = N, duration should be 0 or blank.
                    Inconsistencies generate warnings.
                </div>
                <div class="rule-examples">
                    <h4>✓ Consistent:</h4>
                    <div class="example-good">Parotitis=Y + Duration=5 days</div>
                    <h4>⚠ Inconsistent:</h4>
                    <div class="example-bad">Parotitis=N + Duration=5 days</div>
                </div>
            </div>
        </div>

        <div class="validation-category">
            <h3>2. Laboratory Validation</h3>

            <div class="validation-rule error">
                <div class="rule-title">
                    Lab Result Codes
                    <span class="severity-badge severity-error">ERROR</span>
                </div>
                <div class="rule-description">
                    Lab results must use SNOMED CT codes: 10828004 (Positive), 260385009 (Negative),
                    419984006 (Inconclusive), or 260415000 (Not performed).
                </div>
                <div class="rule-examples">
                    <h4>✓ Valid:</h4>
                    <div class="example-good">10828004, 260385009</div>
                    <h4>✗ Invalid:</h4>
                    <div class="example-bad">positive, negative, pos, neg</div>
                </div>
                <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                <div class="code-block">
LAB_RESULT_CODES = {
    '10828004': 'Positive',
    '260385009': 'Negative',
    '419984006': 'Inconclusive',
    '260415000': 'Not performed'
}

lab_result_str = str(lab_result).strip()
if lab_result_str not in LAB_RESULT_CODES:
    result.add_error("Invalid lab result code")
                </div>
            </div>

            <div class="validation-rule error">
                <div class="rule-title">
                    Specimen Date Before Result Date
                    <span class="severity-badge severity-error">ERROR</span>
                </div>
                <div class="rule-description">
                    Specimen collection date must be before or equal to lab result date. Cannot collect specimen after results.
                </div>
            </div>
        </div>

        <div class="validation-category">
            <h3>3. Complications Tracking</h3>

            <div class="validation-rule warning">
                <div class="rule-title">
                    Mumps Complications
                    <span class="severity-badge severity-warning">WARNING</span>
                </div>
                <div class="rule-description">
                    Tracks mumps complications including: orchitis (testicular inflammation), oophoritis (ovarian),
                    mastitis (breast), encephalitis, meningitis, pancreatitis, and hearing loss. All use Y/N/U values.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- NREVSS Documentation -->
<div class="doc-section">
    <div class="system-doc" id="nrevss">
        <h2>NREVSS (National Respiratory and Enteric Virus Surveillance)</h2>
        <p class="description">
            Laboratory-based surveillance for respiratory viruses with weekly aggregate reporting
        </p>

        <div class="validation-category">
            <h3>1. Reporting Period Validation</h3>

            <div class="validation-rule error">
                <div class="rule-title">
                    CDC Week Format
                    <span class="severity-badge severity-error">ERROR</span>
                </div>
                <div class="rule-description">
                    Reporting week must follow YYYY-WNN format where YYYY is the year and NN is the week number (01-53).
                </div>
                <div class="rule-examples">
                    <h4>✓ Valid:</h4>
                    <div class="example-good">2026-W04, 2026-W52</div>
                    <h4>✗ Invalid:</h4>
                    <div class="example-bad">2026-4, Week 4, 2026W04</div>
                </div>
                <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                <div class="code-block">
import re
pattern = r'^\d{4}-W\d{2}$'
if not re.match(pattern, week_str):
    result.add_error(
        f"Invalid week format: {week_str} (expected YYYY-WNN)"
    )
                </div>
            </div>
        </div>

        <div class="validation-category">
            <h3>2. Specimen Count Validation</h3>

            <div class="validation-rule error">
                <div class="rule-title">
                    Positive + Negative = Total
                    <span class="severity-badge severity-error">ERROR</span>
                </div>
                <div class="rule-description">
                    The sum of positive and negative results must equal the total specimens tested.
                </div>
                <div class="rule-examples">
                    <h4>✓ Valid:</h4>
                    <div class="example-good">Total=100, Positive=20, Negative=80 (20+80=100)</div>
                    <h4>✗ Invalid:</h4>
                    <div class="example-bad">Total=100, Positive=30, Negative=80 (30+80≠100)</div>
                </div>
                <button class="code-toggle" onclick="toggleCode(this)">Show Code</button>
                <div class="code-block">
total_val = int(total)
pos_val = int(positive)
neg_val = int(negative)

if pos_val + neg_val != total_val:
    result.add_error(
        f"Positive ({pos_val}) + Negative ({neg_val}) ≠ Total ({total_val})"
    )
                </div>
            </div>

            <div class="validation-rule warning">
                <div class="rule-title">
                    Percent Positive Calculation
                    <span class="severity-badge severity-warning">WARNING</span>
                </div>
                <div class="rule-description">
                    Validates that reported percent positive matches calculation: (positive/total) × 100.
                    Allows small rounding differences (±0.2%).
                </div>
                <div class="rule-examples">
                    <h4>✓ Valid:</h4>
                    <div class="example-good">Total=100, Positive=20, Percent=20.0%</div>
                    <h4>⚠ Warning:</h4>
                    <div class="example-bad">Total=100, Positive=20, Percent=25.0%</div>
                </div>
            </div>
        </div>

        <div class="validation-category">
            <h3>3. Virus Type Validation</h3>

            <div class="validation-rule warning">
                <div class="rule-title">
                    Recognized Virus Types
                    <span class="severity-badge severity-warning">WARNING</span>
                </div>
                <div class="rule-description">
                    Validates against expected virus types: RSV, Influenza A, Influenza B, Parainfluenza (1-4),
                    Adenovirus, Rhinovirus, Enterovirus, Human Metapneumovirus, Coronavirus, SARS-CoV-2.
                    Unexpected types generate warnings.
                </div>
            </div>
        </div>
    </div>
</div>

<div style="text-align: center; margin: 3rem 0;">
    <a href="/" class="btn btn-secondary">Back to Dashboard</a>
</div>

<script>
function toggleCode(button) {
    const codeBlock = button.nextElementSibling;
    codeBlock.classList.toggle('show');
    button.textContent = codeBlock.classList.contains('show') ? 'Hide Code' : 'Show Code';
}
</script>
{% endblock %}
